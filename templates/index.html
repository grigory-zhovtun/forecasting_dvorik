<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Прогнозирование выручки - Пироговый Дворик</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        :root {
            --primary-color: #FF6B6B;
            --secondary-color: #4ECDC4;
            --dark-color: #2C3E50;
            --light-bg: #F7F9FC;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-color);
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: var(--card-shadow);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .main-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .section-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cafe-checkbox {
            background: var(--light-bg);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .cafe-checkbox:hover {
            background: #e8f4f3;
            transform: translateX(5px);
        }

        .cafe-checkbox input[type="checkbox"] {
            width: 1.2rem;
            height: 1.2rem;
            cursor: pointer;
        }

        .cafe-checkbox label {
            cursor: pointer;
            margin-left: 0.5rem;
            font-weight: 500;
        }

        .slider-container {
            margin-bottom: 1.5rem;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .slider-value {
            color: var(--secondary-color);
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--secondary-color);
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--secondary-color);
            cursor: pointer;
            border: none;
        }

        .btn-forecast {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: var(--card-shadow);
        }

        .btn-forecast:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-export {
            background-color: #28a745;
            color: white;
            font-weight: 600;
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .btn-export:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .results-panel {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            min-height: 500px;
        }

        .date-filter {
            background: var(--light-bg);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        .progress-container {
            display: none;
            margin-top: 2rem;
        }

        .progress {
            height: 25px;
            border-radius: 15px;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            transition: width 0.3s ease;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            margin: 2rem 0;
        }


        .badge-metric {
            font-size: 0.85rem;
            padding: 0.3rem 0.8rem;
        }

        /* Enhanced color coding for metrics with more ranges */
        .metric-excellent {
            background-color: #28a745 !important;
            color: white;
            font-weight: 600;
        }

        .metric-good {
            background-color: #5cb85c !important;
            color: white;
        }
        
        .metric-acceptable {
            background-color: #17a2b8 !important;
            color: white;
        }

        .metric-warning {
            background-color: #ffc107 !important;
            color: #212529;
        }

        .metric-poor {
            background-color: #fd7e14 !important;
            color: white;
        }

        .metric-critical {
            background-color: #dc3545 !important;
            color: white;
            font-weight: 600;
        }
        
        .metric-catastrophic {
            background-color: #721c24 !important;
            color: white;
            font-weight: 700;
            animation: pulse-critical 2s infinite;
        }
        
        @keyframes pulse-critical {
            0% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
            }
        }
        
        /* Recommendation popover styling */
        .recommendation-popover {
            max-width: 400px;
            font-size: 0.9rem;
        }
        
        .recommendation-popover .popover-header {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .recommendation-popover .popover-body {
            padding: 1rem;
        }
        
        .recommendation-list {
            margin: 0;
            padding-left: 1.2rem;
        }
        
        .recommendation-list li {
            margin-bottom: 0.5rem;
        }

        #chartContainer {
            min-height: 400px;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            color: #dee2e6;
            margin-bottom: 1rem;
        }

        .toggle-all {
            margin-bottom: 1rem;
        }

        .advanced-settings {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #e9ecef;
        }

        .form-switch {
            padding-left: 3rem;
        }

        .form-switch .form-check-input {
            width: 3rem;
            height: 1.5rem;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .control-panel, .results-panel {
                margin-bottom: 1rem;
            }

            .btn-forecast {
                width: 100%;
            }
        }
        /* Color groups for summary table with enhanced design */
        .fact-group {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
            position: relative;
        }
        
        .plan-group {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%) !important;
            position: relative;
        }
        
        .total-group {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%) !important;
            position: relative;
            font-weight: 600;
        }
        
        .deviation-group {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%) !important;
            position: relative;
        }
        
        /* Additional enhancements for table cells */
        #cafeSummaryTable td {
            transition: all 0.3s ease;
            position: relative;
        }
        
        #cafeSummaryTable tbody tr:hover td {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        #cafeSummaryTable tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.7) !important;
        }
        
        /* Special styling for delta values */
        .total-group {
            position: relative;
        }
        
        .total-group:before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 60%;
            background: #4caf50;
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        tr:hover .total-group:before {
            opacity: 1;
        }
        
        /* Deviation styling with color indicators */
        .deviation-group {
            font-weight: 600;
        }
        
        .deviation-positive {
            color: #2e7d32;
        }
        
        .deviation-negative {
            color: #c62828;
        }
        
        .deviation-neutral {
            color: #757575;
        }
        
        thead th.fact-group,
        thead th.plan-group,
        thead th.total-group,
        thead th.deviation-group {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
            padding: 1rem;
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
        }
        
        /* Header hover effects */
        thead th:hover {
            background-color: rgba(255, 255, 255, 0.3) !important;
        }
        
        /* Summary table border styling */
        #cafeSummaryTable {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        #cafeSummaryTable thead tr:first-child th:first-child {
            border-top-left-radius: 10px;
        }
        
        #cafeSummaryTable thead tr:first-child th:last-child {
            border-top-right-radius: 10px;
        }
        
        /* Footer styling */
        #cafeSummaryTable tfoot {
            font-weight: 700;
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
        }
        
        #cafeSummaryTable tfoot td {
            border-top: 3px solid #bdbdbd;
            padding: 1rem;
        }
        
        tbody td.fact-group,
        tbody td.plan-group,
        tbody td.total-group,
        tbody td.deviation-group {
            background-color: inherit;
            padding: 0.875rem;
        }
        
        tfoot td.fact-group,
        tfoot td.plan-group,
        tfoot td.total-group,
        tfoot td.deviation-group {
            background-color: transparent !important;
        }
        
        /* Pulse animation for important values */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }
        
        .important-value {
            animation: pulse 2s infinite;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
        }
        
        /* Стили для корректировок */
        .adjustment-item {
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }
        
        .adjustment-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }
        
        .adjustment-item .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="bi bi-graph-up"></i> Прогнозирование выручки - Пироговый Дворик
            </span>
        </div>
    </nav>

    <div class="container-fluid main-container">
        <div class="row">
            <div class="col-lg-3">
                <div class="control-panel">
                    <h3 class="section-title">
                        <i class="bi bi-sliders"></i> Параметры прогноза
                    </h3>

                    <div class="mb-4">
                        <h5 class="mb-3">Выберите кафе для прогноза</h5>
                        <div class="toggle-all">
                            <button class="btn btn-sm btn-outline-secondary" id="selectAll">
                                <i class="bi bi-check-square"></i> Выбрать все
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="deselectAll">
                                <i class="bi bi-square"></i> Снять все
                            </button>
                        </div>
                        <div id="cafeList" class="cafe-list" style="max-height: 300px; overflow-y: auto;">
                            </div>
                    </div>

                    <div class="mb-4">
                        <h5 class="mb-3">Основные параметры</h5>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Горизонт прогноза (дней)</span>
                                <span class="slider-value" id="horizonValue">365</span>
                            </div>
                            <input type="range" id="forecastHorizon" min="30" max="730" value="365" step="30" data-bs-toggle="tooltip" title="Период, на который делается прогноз">
                        </div>


                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Доверительный интервал (%)</span>
                                <span class="slider-value" id="confIntervalValue">95</span>
                            </div>
                            <input type="range" id="confInterval" min="50" max="99" value="95" step="1" data-bs-toggle="tooltip" title="Уровень уверенности для прогноза. Например, 95% означает, что ожидается, что фактическое значение попадет в прогнозируемый диапазон в 95% случаев.">
                        </div>
                    </div>

                    <div class="advanced-settings">
                        <h5 class="mb-3">
                            <i class="bi bi-gear"></i> Расширенные настройки
                        </h5>

                        <div class="form-check form-switch mb-4">
                            <input class="form-check-input" type="checkbox" id="autoTune" data-bs-toggle="tooltip" title="Автоматически подбирает лучшие настройки модели, но может занять больше времени.">
                            <label class="form-check-label" for="autoTune">
                                Автоматическая настройка гиперпараметров
                            </label>
                            <small class="form-text text-muted d-block mt-1">
                                Использует Optuna для поиска оптимальных параметров модели
                            </small>
                        </div>
                        
                        <div class="slider-container mb-4">
                            <div class="slider-label">
                                <span>Доля обучающей выборки (%)</span>
                                <span class="slider-value" id="trainSplitValue">80</span>
                            </div>
                            <input type="range" id="trainSplit" min="50" max="90" value="80" step="5" data-bs-toggle="tooltip" title="Процент исторических данных, используемый для обучения модели.">
                            <small class="form-text text-muted d-block mt-1">
                                Часть данных, используемая для обучения модели (50-90%)
                            </small>
                        </div>
                    
                        <div class="mb-4">
                            <label for="modelType" class="form-label">Модель прогнозирования</label>
                            <select class="form-select" id="modelType" data-bs-toggle="tooltip" title="Prophet: универсальная модель. ARIMA: для стабильных данных. XGBoost: для сложных зависимостей. LSTM: для длинных рядов с сезонностью.">
                                <option value="prophet" selected>Prophet</option>
                                <option value="arima">ARIMA</option>
                                <option value="xgboost">XGBoost</option>
                                <option value="lstm">LSTM (нейронная сеть)</option>
                            </select>
                            <small class="text-muted mt-1 d-block">
                                Выберите алгоритм, который будет использоваться для прогнозирования
                            </small>
                        </div>
                    
                    </div>


                    <div class="mt-4" id="adjustmentsSection" style="display: none;">
                        <h5 class="mb-3">
                            <i class="bi bi-sliders2-vertical"></i> Корректировки
                        </h5>
                        <div id="adjustmentsContainer">
                            <!-- Контент корректировок будет добавлен динамически -->
                        </div>
                    </div>

                    <div class="mt-4 text-center">
                        <button class="btn btn-forecast" id="runForecast">
                            <i class="bi bi-play-circle"></i> Рассчитать прогноз
                        </button>
                        <button class="btn btn-danger ms-2" id="cancelForecast" style="display: none;">
                            <i class="bi bi-stop-circle"></i> Прервать операцию
                        </button>
                    </div>

                    <div class="progress-container" id="progressContainer">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar"
                                 id="progressBar"
                                 style="width: 0%">
                                <span id="progressText">0%</span>
                            </div>
                        </div>
                        <div class="text-center mt-2">
                            <small id="progressMessage" class="text-muted"></small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-9">
                <div class="results-panel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="section-title mb-0">
                            <i class="bi bi-graph-up-arrow"></i> Результаты прогноза
                        </h3>
                        <button class="btn btn-export" id="exportExcel" style="display: none;">
                            <i class="bi bi-file-earmark-excel"></i> Экспорт в Excel
                        </button>
                    </div>

                    <div class="date-filter" id="dateFilter" style="display: none;">
                        <div class="row align-items-end mb-3">
                            <div class="col-md-8">
                                <div class="btn-group" role="group" aria-label="Тип отображения">
                                    <input type="radio" class="btn-check" name="viewType" id="lineChart" value="line" checked>
                                    <label class="btn btn-outline-primary" for="lineChart">
                                        <i class="bi bi-graph-up"></i> График по дням
                                    </label>
                                    <input type="radio" class="btn-check" name="viewType" id="barChart" value="bar">
                                    <label class="btn btn-outline-primary" for="barChart">
                                        <i class="bi bi-bar-chart"></i> Столбцы по периодам
                                    </label>
                                </div>
                                <div class="d-inline-block ms-3" id="aggregationPeriodContainer" style="display: none;">
                                    <label for="aggregationPeriod" class="form-label d-inline me-2">Период агрегации:</label>
                                    <select class="form-select d-inline-block w-auto" id="aggregationPeriod">
                                        <option value="month" selected>Месяц</option>
                                        <option value="quarter">Квартал</option>
                                        <option value="halfyear">Полугодие</option>
                                        <option value="year">Год</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-primary" id="updateChart">
                                    <i class="bi bi-arrow-clockwise"></i> Обновить график
                                </button>
                            </div>
                        </div>
                        <div class="row align-items-end">
                            <div class="col-md-4" id="monthNavigationContainer" style="display: block;">
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-secondary" id="prevMonth">
                                        <i class="bi bi-chevron-left"></i> Пред. месяц
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="currentMonth" disabled style="flex: 1;">
                                        <span id="currentMonthText">Месяц</span>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="nextMonth">
                                        След. месяц <i class="bi bi-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="dateFrom" class="form-label">Дата начала</label>
                                <input type="date" class="form-control" id="dateFrom">
                            </div>
                            <div class="col-md-4">
                                <label for="dateTo" class="form-label">Дата окончания</label>
                                <input type="date" class="form-control" id="dateTo">
                            </div>
                        </div>
                    </div>

                    <div id="chartContainer">
                        <div class="empty-state">
                            <i class="bi bi-graph-up"></i>
                            <h5>Здесь будет отображен прогноз</h5>
                            <p>Выберите кафе и нажмите "Рассчитать прогноз"</p>
                        </div>
                    </div>

                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Построение графика...</p>
                    </div>

                    <!-- Навигационные табы -->
                    <ul class="nav nav-tabs mt-4" id="resultTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">
                                <i class="bi bi-card-list"></i> Сводка
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="metrics-tab" data-bs-toggle="tab" data-bs-target="#metrics" type="button" role="tab">
                                <i class="bi bi-bar-chart-line"></i> Метрики
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                                <i class="bi bi-gear"></i> Настройка
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="passport-tab" data-bs-toggle="tab" data-bs-target="#passport" type="button" role="tab">
                                <i class="bi bi-building"></i> Паспорт
                            </button>
                        </li>
                    </ul>

                    <!-- Содержимое табов -->
                    <div class="tab-content" id="resultTabsContent">
                        <!-- Таб Сводка -->
                        <div class="tab-pane fade show active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
                            <div id="summaryTableContainer" class="mt-4">
                                <div class="table-responsive">
                            <table class="table table-bordered table-striped" id="cafeSummaryTable">
                                <thead class="table-light">
                                    <tr>
                                        <th rowspan="2">Кафе</th>
                                        <th colspan="3" class="text-center plan-group">План</th>
                                        <th colspan="3" class="text-center fact-group">Факт</th>
                                        <th colspan="3" class="text-center total-group">Дельта</th>
                                        <th colspan="3" class="text-center deviation-group">Отклонение</th>
                                    </tr>
                                    <tr>
                                        <th class="plan-group">Выручка</th>
                                        <th class="plan-group">Трафик</th>
                                        <th class="plan-group">Средний чек</th>
                                        <th class="fact-group">Выручка</th>
                                        <th class="fact-group">Трафик</th>
                                        <th class="fact-group">Средний чек</th>
                                        <th class="total-group">Выручка</th>
                                        <th class="total-group">Трафик</th>
                                        <th class="total-group">Средний чек</th>
                                        <th class="deviation-group">Выручка, %</th>
                                        <th class="deviation-group">Трафик, %</th>
                                        <th class="deviation-group">Средний чек, %</th>
                                    </tr>
                                </thead>
                                <tbody id="cafeSummaryBody">
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <th>Итого</th>
                                        <td id="totalRevenueForecast" class="plan-group">---</td>
                                        <td id="totalTrafficForecast" class="plan-group">---</td>
                                        <td id="totalAvgCheckForecast" class="plan-group">---</td>
                                        <td id="totalRevenueActual" class="fact-group">---</td>
                                        <td id="totalTrafficActual" class="fact-group">---</td>
                                        <td id="totalAvgCheckActual" class="fact-group">---</td>
                                        <td id="totalRevenueTotal" class="total-group">---</td>
                                        <td id="totalTrafficTotal" class="total-group">---</td>
                                        <td id="totalAvgCheckTotal" class="total-group">---</td>
                                        <td id="totalRevenueDeviation" class="deviation-group">---</td>
                                        <td id="totalTrafficDeviation" class="deviation-group">---</td>
                                        <td id="totalAvgCheckDeviation" class="deviation-group">---</td>
                                    </tr>
                                </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Таб Метрики -->
                        <div class="tab-pane fade" id="metrics" role="tabpanel" aria-labelledby="metrics-tab">
                            <div id="metricsContainer" class="mt-4">
                        <h4 class="mb-3 section-title"><i class="bi bi-bar-chart-line"></i> Метрики качества прогноза</h4>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Кафе</th>
                                        <th>Показатель</th>
                                        <th>MAPE, %</th>
                                        <th>MAE</th>
                                        <th>RMSE</th>
                                        <th>R²</th>
                                        <th>Рекомендации</th>
                                    </tr>
                                </thead>
                                <tbody id="metricsTable">
                                </tbody>
                            </table>
                                </div>
                                <div class="mt-4 p-3 bg-light rounded">
                                    <h5>Справка по метрикам:</h5>
                                    <ul class="mb-0" style="font-size: 0.9rem;">
                                        <li class="mb-2"><strong>MAPE, %</strong> — показывает, на сколько процентов в среднем прогноз отличается от факта.
                                            <br>📌 Если MAPE = 10% для доставки, это значит, что при среднем доходе 25 000 000 ₽ в месяц, мы в среднем ошибаемся на 2 500 000 ₽.
                                            <br>📌 Если MAPE = 10% для ПД-01, ошибка составит около 200 000 ₽ в месяц.
                                        </li>
                                        <li class="mb-2"><strong>MAE</strong> — средняя ошибка в рублях: показывает, на сколько рублей мы обычно ошибаемся.
                                            <br>📌 MAE = 1 000 000 ₽ для доставки — значит, каждый месяц мы ошибаемся в прогнозе примерно на миллион, иногда выше, иногда ниже.
                                            <br>📌 MAE = 150 000 ₽ для ПД-01 — значит, что в среднем мы не угадываем на 150 000 ₽.
                                        </li>
                                        <li class="mb-2"><strong>RMSE</strong> — тоже ошибка в рублях, но она сильнее реагирует на большие промахи.
                                            <br>📌 Если в одном месяце прогноз доставки промахнулся на 5 000 000 ₽, RMSE вырастет больше, чем MAE, и, например, покажет 1 800 000 ₽.
                                            <br>📌 Для ПД-01, если был один крупный промах, RMSE может быть 250 000 ₽, даже если MAE — 150 000 ₽.
                                        </li>
                                        <li><strong>R²</strong> — показывает, насколько хорошо модель "понимает" поведение выручки.
                                            <br>📌 Если R² = 0.9 у доставки — это значит, что модель предсказывает скачки (например, из-за акций или плохой погоды) довольно точно.
                                            <br>📌 Если у ПД-01 R² = 0.5 — модель угадывает поведение хуже, не всегда видит причины роста или спада выручки.
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Таб Настройка -->
                        <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                            <div id="settingsContainer" class="mt-4">
                                <h4 class="mb-3 section-title"><i class="bi bi-gear"></i> Настройка параметров прогноза по кафе</h4>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="settingsTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th rowspan="2" style="vertical-align: middle;">Кафе</th>
                                                <th colspan="3" class="text-center">Сезонность</th>
                                                <th colspan="2" class="text-center">Чувствительность модели</th>
                                                <th rowspan="2" style="vertical-align: middle;">Учитывать праздники</th>
                                                <th rowspan="2" style="vertical-align: middle;">Удалять выбросы</th>
                                            </tr>
                                            <tr>
                                                <th>Годовая</th>
                                                <th>Недельная</th>
                                                <th>Дневная</th>
                                                <th>К тренду</th>
                                                <th>К сезонности</th>
                                            </tr>
                                        </thead>
                                        <tbody id="settingsTableBody">
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-primary" id="applySettings">
                                        <i class="bi bi-check-circle"></i> Применить настройки
                                    </button>
                                    <button class="btn btn-secondary ms-2" id="resetSettings">
                                        <i class="bi bi-arrow-counterclockwise"></i> Сбросить на стандартные
                                    </button>
                                </div>
                                <div class="mt-4 p-3 bg-light rounded">
                                    <h5>Подсказки по настройкам:</h5>
                                    <ul class="mb-0">
                                        <li><strong>Сезонность:</strong> Включите те типы сезонности, которые характерны для конкретного кафе</li>
                                        <li><strong>Чувствительность к тренду (0.001-0.5):</strong> Чем выше значение, тем быстрее модель реагирует на изменения тренда</li>
                                        <li><strong>Чувствительность к сезонности (0.1-25):</strong> Определяет силу сезонных колебаний</li>
                                        <li><strong>Учитывать праздники:</strong> Включите для кафе в торговых центрах и местах с высоким трафиком</li>
                                        <li><strong>Удалять выбросы:</strong> Рекомендуется для стабильной работы, отключите для новых кафе</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Таб Паспорт -->
                        <div class="tab-pane fade" id="passport" role="tabpanel" aria-labelledby="passport-tab">
                            <div id="passportContainer" class="mt-4">
                                <h4 class="mb-3 section-title"><i class="bi bi-building"></i> Паспорт кафе</h4>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="passportTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Кафе</th>
                                                <th>Дата открытия</th>
                                                <th>Дней работает</th>
                                                <th>Посадочных мест</th>
                                                <th>Расположение</th>
                                                <th>Штат</th>
                                                <th>Площадь, м²</th>
                                                <th>Парковка</th>
                                                <th>Доставка</th>
                                                <th>Чеков/сотрудник</th>
                                                <th>ТО/сотрудник</th>
                                            </tr>
                                        </thead>
                                        <tbody id="passportTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Глобальные переменные
        let cafes = [];
        let forecastData = null;
        let cancelRequested = false;
        let currentViewType = 'line';
        let currentAggregationPeriod = 'month';
        let currentMonth = new Date();

        // Инициализация
        $(document).ready(function() {
            console.log('Инициализация приложения...');
            loadInitialData();
            setupEventHandlers();
            loadPassportData();
            
            // Установка начального состояния интерфейса
            $('#aggregationPeriodContainer').hide();
            $('#monthNavigationContainer').show();
            
            // Инициализация тултипов Bootstrap
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });

        // Загрузка данных паспорта
        function loadPassportData() {
            $.get('/api/passport_data', function(response) {
                if (response.passport_data && response.passport_data.length > 0) {
                    const tbody = $('#passportTableBody');
                    tbody.empty();
                    
                    response.passport_data.forEach(cafe => {
                        const row = $(`
                            <tr>
                                <td><strong>${cafe.cafe}</strong></td>
                                <td>${new Date(cafe.open_date).toLocaleDateString('ru-RU')}</td>
                                <td>${cafe.days_working}</td>
                                <td>${cafe.seats}</td>
                                <td>${cafe.location_type}</td>
                                <td>${cafe.staff_count}</td>
                                <td>${cafe.area_sqm}</td>
                                <td>${cafe.parking}</td>
                                <td>${cafe.delivery}</td>
                                <td>${cafe.checks_per_staff}</td>
                                <td>${cafe.revenue_per_staff.toLocaleString('ru-RU')} ₽</td>
                            </tr>
                        `);
                        tbody.append(row);
                    });
                }
            }).fail(function(error) {
                console.error('Ошибка загрузки данных паспорта:', error);
            });
        }

        // Загрузка настроек по кафе
        function loadCafeSettings() {
            const tbody = $('#settingsTableBody');
            tbody.empty();
            
            // Дефолтные настройки
            const defaultSettings = {
                yearly_seasonality: true,
                weekly_seasonality: true,
                daily_seasonality: false,
                changepoint_prior_scale: 0.05,
                seasonality_prior_scale: 10.0,
                holidays_enabled: true,
                remove_outliers: true
            };
            
            cafes.forEach(cafe => {
                const row = $(`
                    <tr data-cafe="${cafe}">
                        <td><strong>${cafe}</strong></td>
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input yearly-season" ${defaultSettings.yearly_seasonality ? 'checked' : ''}>
                        </td>
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input weekly-season" ${defaultSettings.weekly_seasonality ? 'checked' : ''}>
                        </td>
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input daily-season" ${defaultSettings.daily_seasonality ? 'checked' : ''}>
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm trend-scale" 
                                   value="${defaultSettings.changepoint_prior_scale}" 
                                   min="0.001" max="0.5" step="0.001"
                                   data-bs-toggle="tooltip" title="Рекомендуется: 0.05 для стабильных кафе, 0.1-0.2 для новых">
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm seasonality-scale" 
                                   value="${defaultSettings.seasonality_prior_scale}" 
                                   min="0.1" max="25" step="0.1"
                                   data-bs-toggle="tooltip" title="Рекомендуется: 10 для обычных кафе, 20 для кафе с высокой сезонностью">
                        </td>
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input holidays-enabled" ${defaultSettings.holidays_enabled ? 'checked' : ''}>
                        </td>
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input outliers-enabled" ${defaultSettings.remove_outliers ? 'checked' : ''}>
                        </td>
                    </tr>
                `);
                tbody.append(row);
            });
            
            // Инициализация тултипов
            $('[data-bs-toggle="tooltip"]').tooltip();
        }
        
        // Применение настроек
        function applyCafeSettings() {
            const settings = {};
            
            $('#settingsTableBody tr').each(function() {
                const row = $(this);
                const cafe = row.data('cafe');
                
                settings[cafe] = {
                    yearly_seasonality: row.find('.yearly-season').is(':checked'),
                    weekly_seasonality: row.find('.weekly-season').is(':checked'),
                    daily_seasonality: row.find('.daily-season').is(':checked'),
                    changepoint_prior_scale: parseFloat(row.find('.trend-scale').val()),
                    seasonality_prior_scale: parseFloat(row.find('.seasonality-scale').val()),
                    holidays_enabled: row.find('.holidays-enabled').is(':checked'),
                    remove_outliers: row.find('.outliers-enabled').is(':checked')
                };
            });
            
            // Сохраняем настройки в localStorage
            localStorage.setItem('cafeSettings', JSON.stringify(settings));
            alert('Настройки сохранены');
        }

        // Функция для определения цветового класса на основе MAPE
        function getMapeColorClass(mapeValue) {
            if (mapeValue <= 5) {
                return 'metric-excellent';      // Отличный прогноз
            } else if (mapeValue <= 10) {
                return 'metric-good';           // Хороший прогноз
            } else if (mapeValue <= 15) {
                return 'metric-acceptable';     // Приемлемый прогноз
            } else if (mapeValue <= 20) {
                return 'metric-warning';        // Требует внимания
            } else if (mapeValue <= 30) {
                return 'metric-poor';           // Плохой прогноз
            } else if (mapeValue <= 40) {
                return 'metric-critical';       // Критический прогноз
            } else {
                return 'metric-catastrophic';   // Катастрофический прогноз
            }
        }

        // Загрузка начальных данных
        function loadInitialData() {
            console.log('Загрузка начальных данных...');
            $.get('/api/get_initial_data', function(data) {
                console.log('Получены данные:', data);
                cafes = data.cafes;
                renderCafeList();
                loadCafeSettings();

                // Установка диапазона дат
                if (data.date_range) {
                    $('#dateFrom').attr('min', data.date_range.min);
                    $('#dateTo').attr('max', new Date(new Date(data.date_range.max).getTime() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
                }
                 // Опционально: Установка значений по умолчанию для контролов из data.default_params
                if (data.default_params) {
                    $('#forecastHorizon').val(data.default_params.forecast_horizon);
                    $('#horizonValue').text(data.default_params.forecast_horizon);

                    // Удалены настройки remove_outliers и outlier_multiplier
                    
                    if (data.default_params.confidence_interval) {
                        $('#confInterval').val(data.default_params.confidence_interval * 100);
                        $('#confIntervalValue').text(data.default_params.confidence_interval * 100);
                    }

                    // Удалены настройки Prophet - теперь берутся из вкладки Настройка
                }
                
            }).fail(function(error) {
                console.error('Ошибка загрузки данных:', error);
                alert('Ошибка загрузки данных. Проверьте подключение к серверу.');
            });
        }
        

        // Отрисовка списка кафе
        function renderCafeList() {
            const container = $('#cafeList');
            container.empty();

            cafes.forEach((cafe, index) => {
                const item = $(`
                    <div class="cafe-checkbox">
                        <div class="form-check">
                            <input class="form-check-input cafe-select" type="checkbox"
                                   value="${cafe}" id="cafe${index}">
                            <label class="form-check-label" for="cafe${index}">
                                ${cafe}
                            </label>
                        </div>
                    </div>
                `);
                container.append(item);
            });
        }

        // Функции для навигации по месяцам
        function updateMonthNavigation() {
            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                              'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            const monthText = monthNames[currentMonth.getMonth()] + ' ' + currentMonth.getFullYear();
            $('#currentMonthText').text(monthText);
        }

        function setDatesForCurrentMonth() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            $('#dateFrom').val(firstDay.toISOString().split('T')[0]);
            $('#dateTo').val(lastDay.toISOString().split('T')[0]);
        }
        
        function updateMonthIndicatorFromDates() {
            const dateFrom = $('#dateFrom').val();
            const dateTo = $('#dateTo').val();
            
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                const toDate = dateTo ? new Date(dateTo) : fromDate;
                
                // Проверяем, покрывают ли даты полный месяц
                const firstDay = new Date(fromDate.getFullYear(), fromDate.getMonth(), 1);
                const lastDay = new Date(fromDate.getFullYear(), fromDate.getMonth() + 1, 0);
                
                if (fromDate.getTime() === firstDay.getTime() && 
                    toDate.getTime() === lastDay.getTime()) {
                    // Это полный месяц, обновляем индикатор
                    currentMonth = new Date(fromDate);
                    updateMonthNavigation();
                }
            }
        }

        // Обновление списка кафе для корректировок
        function updateAdjustmentCafeList() {
            // Обновляем все селекты кафе в корректировках
            $('.adj-cafe').each(function() {
                const select = $(this);
                const currentValue = select.val();
                select.empty();
                select.append('<option value="ALL">Все кафе</option>');
                cafes.forEach(cafe => {
                    select.append(`<option value="${cafe}">${cafe}</option>`);
                });
                // Восстанавливаем выбранное значение
                if (currentValue) {
                    select.val(currentValue);
                }
            });
            
            // Настройка интерфейса в зависимости от выбранной модели
            $("#modelType").off('change').on('change', function() {
                const modelType = $(this).val();
                
                // Показываем информацию о выбранной модели
                const modelInfo = {
                    'prophet': 'Facebook Prophet - универсальная модель для большинства случаев',
                    'arima': 'ARIMA - классическая статистическая модель, подходит для стабильных данных',
                    'xgboost': 'XGBoost - мощная модель машинного обучения, хорошо работает со сложными зависимостями',
                    'lstm': 'LSTM - нейронная сеть, лучше всего подходит для длинных временных рядов с сезонностью'
                };
                
                $(this).next('small').text(modelInfo[modelType]);
            });
        }

        // Настройка обработчиков событий
        function setupEventHandlers() {
            
            // Обработчик для менеджера корректировок
            // Слайдеры
            $('#forecastHorizon').on('input', function() {
                $('#horizonValue').text($(this).val());
            });

            $('#confInterval').on('input', function() {
                $('#confIntervalValue').text($(this).val());
            });

            // Выбрать/снять все
            $('#selectAll').click(function() {
                $('.cafe-select').prop('checked', true);
            });
            
            $("#trainSplit").on("input", function() {
                $("#trainSplitValue").text($(this).val());
            });

            $('#deselectAll').click(function() {
                $('.cafe-select').prop('checked', false);
            });

            // Добавление корректировки

            // Сохранение корректировки

            // Запуск прогнозирования
            $('#runForecast').click(runForecast);

            // Отмена прогнозирования
            $('#cancelForecast').click(function() {
                cancelRequested = true;
                $(this).prop('disabled', true).text('Отменяется...');
                
                // Отправляем запрос на отмену
                $.ajax({
                    url: '/api/cancel_forecast',
                    method: 'POST',
                    success: function() {
                        console.log('Прогнозирование отменено');
                    }
                });
            });

            // Обновление графика
            $('#updateChart').click(updateChart);

            // Экспорт в Excel
            $('#exportExcel').click(function() {
                window.location.href = '/api/export_excel';
            });

            // Обработчик переключения типа отображения
            $('input[name="viewType"]').change(function() {
                currentViewType = $(this).val();
                if (currentViewType === 'bar') {
                    $('#aggregationPeriodContainer').show();
                    $('#monthNavigationContainer').hide();
                } else {
                    $('#aggregationPeriodContainer').hide();
                    $('#monthNavigationContainer').show();
                }
                updateChart();
            });
            
            // Обработчик изменения дат вручную
            $('#dateFrom, #dateTo').change(function() {
                updateMonthIndicatorFromDates();
            });

            // Обработчик изменения периода агрегации
            $('#aggregationPeriod').change(function() {
                currentAggregationPeriod = $(this).val();
                updateChart();
            });

            // Обработчики навигации по месяцам
            $('#prevMonth').click(function() {
                currentMonth.setMonth(currentMonth.getMonth() - 1);
                updateMonthNavigation();
                setDatesForCurrentMonth();
                updateChart();
            });

            $('#nextMonth').click(function() {
                currentMonth.setMonth(currentMonth.getMonth() + 1);
                updateMonthNavigation();
                setDatesForCurrentMonth();
                updateChart();
            });

            // Обработчики для панели настроек
            $('#applySettings').click(function() {
                applyCafeSettings();
            });

            $('#resetSettings').click(function() {
                if (confirm('Сбросить настройки на стандартные?')) {
                    localStorage.removeItem('cafeSettings');
                    loadCafeSettings();
                    alert('Настройки сброшены на стандартные');
                }
            });
        }

        // Отрисовка корректировок

        // Запуск прогнозирования
        function runForecast() {
            const selectedCafes = $('.cafe-select:checked').map(function() {
                return $(this).val();
            }).get();

            if (selectedCafes.length === 0) {
                alert('Выберите хотя бы одно кафе для прогноза');
                return;
            }

            console.log('Выбранные кафе:', selectedCafes);

            // Получаем настройки по кафе из localStorage или используем дефолтные
            const savedSettings = localStorage.getItem('cafeSettings');
            const cafeSettings = savedSettings ? JSON.parse(savedSettings) : {};
            
            const params = {
                cafes: selectedCafes,
                forecast_horizon: parseInt($('#forecastHorizon').val()),
                confidence_interval: parseFloat($('#confInterval').val()) / 100,
                // Model specific parameters
                model_type: $('#modelType').val(),
                auto_tune: $('#autoTune').is(':checked'),
                train_split: parseFloat($('#trainSplit').val()) / 100,
                // Параметры по кафе из вкладки Настройка
                cafe_settings: cafeSettings
            };

            // Add display date filters to params if they are set
            const displayDateFrom = $('#dateFrom').val();
            if (displayDateFrom) {
                params.date_filter_from = displayDateFrom;
            }

            const displayDateTo = $('#dateTo').val();
            if (displayDateTo) {
                params.date_filter_to = displayDateTo;
            }

            console.log('Параметры прогноза:', params);

            // Показать прогресс
            $('#progressContainer').show();
            $('#runForecast').prop('disabled', true);
            $('#cancelForecast').show().prop('disabled', false).text('Прервать операцию');
            cancelRequested = false;

            // Запуск прогнозирования
            $.ajax({
                url: '/api/forecast',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(params),
                success: function(response) {
                    console.log('Прогнозирование запущено:', response);
                    // Мониторинг прогресса
                    monitorProgress();
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка при запуске прогнозирования:', error);
                    alert('Ошибка при запуске прогнозирования: ' + (xhr.responseJSON ? xhr.responseJSON.error : error) );
                    $('#progressContainer').hide();
                    $('#runForecast').prop('disabled', false);
                }
            });
        }

        // Мониторинг прогресса
        function monitorProgress() {
            const interval = setInterval(function() {
                if (cancelRequested) {
                    clearInterval(interval);
                    $('#progressContainer').hide();
                    $('#runForecast').prop('disabled', false);
                    $('#cancelForecast').hide();
                    $('#progressBar').css('width', '0%');
                    $('#progressText').text('0%');
                    $('#progressMessage').text('Прогнозирование отменено');
                    return;
                }
                
                $.get('/api/progress', function(data) {
                    console.log('Прогресс:', data);
                    if (data.status === 'complete') {
                        clearInterval(interval);
                        $('#progressContainer').hide();
                        $('#runForecast').prop('disabled', false);
                        $('#cancelForecast').hide();
                        loadForecastResults();
                    } else if (data.status === 'cancelled') {
                        clearInterval(interval);
                        $('#progressContainer').hide();
                        $('#runForecast').prop('disabled', false);
                        $('#cancelForecast').hide();
                        $('#progressMessage').text('Прогнозирование отменено');
                    } else if (data.percentage !== undefined) {
                        $('#progressBar').css('width', data.percentage + '%');
                        $('#progressText').text(data.percentage + '%');
                        $('#progressMessage').text(data.message || '');
                    }
                }).fail(function() { // Добавил обработку ошибки для /api/progress
                    clearInterval(interval);
                    $('#progressContainer').hide();
                    $('#runForecast').prop('disabled', false);
                    $('#cancelForecast').hide();
                    alert('Ошибка при получении прогресса прогнозирования.');
                });
            }, 500);
        }

        // Загрузка результатов прогноза
        function loadForecastResults() {
            console.log('Загрузка результатов прогноза...');
            $('#dateFilter').show();
            $('#exportExcel').show();
            $('.loading-spinner').show();
            $('#chartContainer').html('<div id="plotlyChart"></div>'); // Очистка перед загрузкой нового графика
            
            // Устанавливаем текущий месяц по умолчанию
            currentMonth = new Date();
            setDatesForCurrentMonth();
            updateMonthNavigation();

            $.get('/api/get_forecast_data', function(response) {
                console.log('Получены данные для графика:', response);
                $('.loading-spinner').hide();

                if (response.error) { // Обработка ошибки от сервера
                     $('#chartContainer').html(`
                        <div class="empty-state">
                            <i class="bi bi-exclamation-triangle"></i>
                            <h5>Ошибка загрузки данных для графика</h5>
                            <p>${response.error}</p>
                        </div>
                    `);
                    return;
                }

                if (response.data && response.data.length > 0) {
                    const config = {
                        responsive: true,
                        displayModeBar: true,
                        modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                        displaylogo: false
                    };

                    Plotly.newPlot('plotlyChart', response.data, response.layout, config);
                    if (response.summary_data) {
                        renderSummaryTable(response.summary_data);
                    } else {
                        renderSummaryTable(null); // Clear table or show default
                    }
                    
                    // Инициализируем навигацию по месяцам при загрузке результатов
                    updateMonthNavigation();
                    
                    // Обновляем даты если они пришли с сервера
                    if (response.current_dates) {
                        if (response.current_dates.date_from) {
                            $('#dateFrom').val(response.current_dates.date_from);
                        }
                        if (response.current_dates.date_to) {
                            $('#dateTo').val(response.current_dates.date_to);
                        }
                        updateMonthIndicatorFromDates();
                    }
                    
                    // Табы уже видны, панель корректировок показывается через табы
                    
                    // Сохраняем данные для корректировок
                    forecastData = response;
                    
                    // Обновляем метрики с рекомендациями
                    if (response.metrics && Object.keys(response.metrics).length > 0) {
                        try {
                            renderMetricsTable(response.metrics, response.structured_recommendations);
                        } catch (e) {
                            console.error('Ошибка при отображении метрик:', e);
                        }
                    }
                    
                    // Показываем раздел корректировок после прогноза
                    $('#adjustmentsSection').show();
                    loadAdjustmentsManager();
                } else {
                    $('#chartContainer').html(`
                        <div class="empty-state">
                            <i class="bi bi-exclamation-circle"></i>
                            <h5>Нет данных для отображения</h5>
                            <p>Попробуйте изменить параметры или выбрать другие кафе.</p>
                        </div>
                    `);
                    renderSummaryTable(null); // Clear table if no chart data
                }
            }).fail(function(xhr, status, error) {
                $('.loading-spinner').hide();
                renderSummaryTable(null); // Clear table on error
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'Неизвестная ошибка';
                console.error('Ошибка загрузки данных для графика:', errorMsg);
                $('#chartContainer').html(`
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle"></i>
                        <h5>Ошибка загрузки данных для графика</h5>
                        <p>${errorMsg}. Проверьте консоль для деталей.</p>
                    </div>
                `);
            });
        }

        // Функция загрузки менеджера корректировок
        function loadAdjustmentsManager() {
            const container = $('#adjustmentsContainer');
            container.html(`
                <div class="mb-3">
                    <button class="btn btn-sm btn-primary" id="addAdjustment">
                        <i class="bi bi-plus-circle"></i> Добавить корректировку
                    </button>
                </div>
                <div id="adjustmentsList"></div>
                <div class="mt-3">
                    <button class="btn btn-success" id="applyAdjustments" style="display: none;">
                        <i class="bi bi-check-circle"></i> Применить корректировки
                    </button>
                </div>
            `);
            
            updateAdjustmentCafeList();
            
            // Обработчик добавления корректировки
            $('#addAdjustment').click(function() {
                const adjId = Date.now();
                const adjItem = $(`
                    <div class="card mb-3 adjustment-item" data-adj-id="${adjId}">
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <label class="form-label small">Кафе</label>
                                    <select class="form-select adj-cafe" id="adjCafe${adjId}">
                                        <option value="ALL">Все кафе</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Показатель</label>
                                    <select class="form-select adj-metric">
                                        <option value="revenue">Выручка</option>
                                        <option value="traffic">Трафик</option>
                                        <option value="avg_check">Средний чек</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <label class="form-label small">Тип корректировки</label>
                                    <select class="form-select adj-type">
                                        <option value="percent">Процент</option>
                                        <option value="absolute">Абсолютное значение</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Значение</label>
                                    <input type="number" class="form-control adj-value" step="any" placeholder="0">
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <label class="form-label small">Дата начала</label>
                                    <input type="date" class="form-control adj-date-from">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Дата окончания</label>
                                    <input type="date" class="form-control adj-date-to">
                                </div>
                            </div>
                            <div class="text-end">
                                <button class="btn btn-sm btn-danger remove-adj">
                                    <i class="bi bi-trash"></i> Удалить
                                </button>
                            </div>
                        </div>
                    </div>
                `);
                
                $('#adjustmentsList').append(adjItem);
                updateAdjustmentCafeList();
                $('#applyAdjustments').show();
                
                // Обработчик удаления
                adjItem.find('.remove-adj').click(function() {
                    adjItem.remove();
                    if ($('.adjustment-item').length === 0) {
                        $('#applyAdjustments').hide();
                    }
                });
            });
            
            // Обработчик применения корректировок
            $('#applyAdjustments').click(function() {
                const adjustments = [];
                $('.adjustment-item').each(function() {
                    const item = $(this);
                    adjustments.push({
                        cafe: item.find('.adj-cafe').val(),
                        metric: item.find('.adj-metric').val(),
                        type: item.find('.adj-type').val(),
                        value: parseFloat(item.find('.adj-value').val()),
                        dateFrom: item.find('.adj-date-from').val(),
                        dateTo: item.find('.adj-date-to').val()
                    });
                });
                
                $.ajax({
                    url: '/api/apply_adjustments',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ adjustments: adjustments }),
                    success: function(response) {
                        // Обновляем график с корректировками
                        Plotly.react('plotlyChart', response.data, response.layout);
                        if (response.summary_data) {
                            renderSummaryTable(response.summary_data);
                        }
                        alert('Корректировки применены');
                    },
                    error: function(xhr) {
                        alert('Ошибка при применении корректировок: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Неизвестная ошибка'));
                    }
                });
            });
        }

        // Обновление графика с фильтрами
        function updateChart() {
            const dateFrom = $('#dateFrom').val();
            const dateTo = $('#dateTo').val();

            let url = '/api/get_forecast_data?';
            if (dateFrom) url += `date_from=${dateFrom}&`;
            if (dateTo) url += `date_to=${dateTo}&`;
            url += `view_type=${currentViewType}&`;
            if (currentViewType === 'bar') {
                url += `aggregation_period=${currentAggregationPeriod}&`;
            }

            $('.loading-spinner').show();
             // Убедимся, что есть контейнер для графика
            if ($('#plotlyChart').length === 0) {
                $('#chartContainer').html('<div id="plotlyChart"></div>');
            }


            $.get(url, function(response) {
                $('.loading-spinner').hide();
                 if (response.error) { // Обработка ошибки от сервера
                     alert('Ошибка при обновлении графика: ' + response.error);
                    return;
                }
                if (response.data && response.data.length > 0) {
                    Plotly.react('plotlyChart', response.data, response.layout);
                    if (response.summary_data) {
                        renderSummaryTable(response.summary_data);
                    } else {
                        renderSummaryTable(null);
                    }

                    // Обновляем метрики качества
                    if (response.metrics && Object.keys(response.metrics).length > 0) {
                        try {
                            renderMetricsTable(response.metrics, response.structured_recommendations);
                        } catch (e) {
                            console.error('Ошибка при обновлении метрик:', e);
                        }
                    }
                    
                    // Обновляем даты если они пришли с сервера
                    if (response.current_dates) {
                        if (response.current_dates.date_from) {
                            $('#dateFrom').val(response.current_dates.date_from);
                        }
                        if (response.current_dates.date_to) {
                            $('#dateTo').val(response.current_dates.date_to);
                        }
                        updateMonthIndicatorFromDates();
                    }

                } else {
                     $('#chartContainer').html(`
                        <div class="empty-state">
                            <i class="bi bi-exclamation-circle"></i>
                            <h5>Нет данных для отображения по выбранным датам</h5>
                        </div>
                    `);
                    renderSummaryTable(null);
                }
            }).fail(function(xhr, status, error) {
                $('.loading-spinner').hide();
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'Неизвестная ошибка';
                alert('Ошибка при обновлении графика: ' + errorMsg);
                renderSummaryTable(null);
            });
        }

        // Функция для отрисовки таблицы с метриками
        function renderMetricsTable(metrics, structuredRecommendations) {
            const metricsTable = $("#metricsTable");
            metricsTable.empty();
            
            Object.entries(metrics).forEach(([cafe, cafeMetrics]) => {
                const metricTypes = ['revenue', 'traffic', 'check'];
                const metricNames = {
                    'revenue': 'Выручка',
                    'traffic': 'Трафик',
                    'check': 'Средний чек'
                };
                
                metricTypes.forEach((metricType, index) => {
                    let row = $('<tr>');
                    
                    // Кафе (только для первой строки)
                    if (index === 0) {
                        row.append($('<td>').attr('rowspan', 3).css('vertical-align', 'middle').html(`<strong>${cafe}</strong>`));
                    }
                    
                    // Показатель
                    row.append($('<td>').text(metricNames[metricType]));
                    
                    // MAPE с цветовой разметкой
                    let mapeCell = $('<td>');
                    const mapeKey = `MAPE_${metricType}`;
                    if (cafeMetrics[mapeKey] !== null && cafeMetrics[mapeKey] !== undefined) {
                        let mapeValue = cafeMetrics[mapeKey];
                        let mapeClass = getMapeColorClass(mapeValue);
                        mapeCell.html(`<span class="badge ${mapeClass}">${mapeValue.toFixed(2)}%</span>`);
                    } else {
                        mapeCell.text("N/A");
                    }
                    row.append(mapeCell);
                    
                    // MAE
                    const maeKey = `MAE_${metricType}`;
                    const maeValue = cafeMetrics[maeKey];
                    let maeText = "N/A";
                    if (maeValue !== null && maeValue !== undefined) {
                        if (metricType === 'traffic') {
                            maeText = maeValue.toLocaleString('ru-RU');
                        } else {
                            maeText = maeValue.toLocaleString('ru-RU') + " ₽";
                        }
                    }
                    row.append($('<td>').text(maeText));
                    
                    // RMSE
                    const rmseKey = `RMSE_${metricType}`;
                    const rmseValue = cafeMetrics[rmseKey];
                    let rmseText = "N/A";
                    if (rmseValue !== null && rmseValue !== undefined) {
                        if (metricType === 'traffic') {
                            rmseText = rmseValue.toLocaleString('ru-RU');
                        } else {
                            rmseText = rmseValue.toLocaleString('ru-RU') + " ₽";
                        }
                    }
                    row.append($('<td>').text(rmseText));
                    
                    // R²
                    const r2Key = `R2_${metricType}`;
                    const r2Value = cafeMetrics[r2Key];
                    row.append($('<td>').text(r2Value !== null ? r2Value.toFixed(4) : "N/A"));
                    
                    // Рекомендации (только для первой строки)
                    if (index === 0) {
                        let recCell = $('<td>').attr('rowspan', 3).css('vertical-align', 'middle');
                        
                        if (structuredRecommendations && structuredRecommendations[cafe]) {
                            const structRecs = structuredRecommendations[cafe];
                            
                            // Создаем кнопку для рекомендаций
                            const btnId = `rec-btn-${cafe.replace(/\s+/g, '-')}`;
                            recCell.html(`
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                        id="${btnId}"
                                        data-bs-toggle="popover"
                                        data-bs-trigger="focus"
                                        title="Рекомендации для ${cafe}">
                                    <i class="bi bi-lightbulb"></i> Показать
                                </button>
                            `);
                            
                            // Формируем контент для поповера
                            let popoverContent = '<div class="recommendation-content">';
                            
                            metricTypes.forEach(mType => {
                                if (structRecs[mType]) {
                                    const rec = structRecs[mType];
                                    // Безопасное получение значений с дефолтами
                                    const colorClass = rec.color_class || 'metric-warning';
                                    const qualityRus = rec.quality_rus || 'Неопределено';
                                    const generalRec = rec.general_recommendation || 'Требуется анализ данных';
                                    const actionReq = rec.action_required || 'Проверьте настройки модели';
                                    const allTips = rec.all_tips || ['Проверьте качество данных'];
                                    
                                    popoverContent += `
                                        <div class="mb-3">
                                            <h6>${metricNames[mType]} 
                                                <span class="badge ${colorClass}">${qualityRus}</span>
                                            </h6>
                                            <p class="mb-1"><strong>${generalRec}</strong></p>
                                            <p class="mb-1 text-danger">${actionReq}</p>
                                            <ul class="recommendation-list small">
                                                ${allTips.slice(0, 3).map(tip => `<li>${tip}</li>`).join('')}
                                            </ul>
                                        </div>
                                    `;
                                }
                            });
                            
                            popoverContent += '</div>';
                            
                            // Инициализация поповера после добавления в DOM
                            setTimeout(() => {
                                const popover = new bootstrap.Popover(document.getElementById(btnId), {
                                    html: true,
                                    content: popoverContent,
                                    placement: 'left',
                                    customClass: 'recommendation-popover',
                                    sanitize: false
                                });
                            }, 100);
                        }
                        
                        row.append(recCell);
                    }
                    
                    metricsTable.append(row);
                });
            });
        }
        
        // Функция для отрисовки таблицы со сводными данными
        function renderSummaryTable(summaryData) {
            const formatNumber = (num, options = {}) => {
                if (isNaN(num) || num === null || num === undefined) return '---';
                return num.toLocaleString('ru-RU', options);
            };
            
            const calculateDeviation = (actual, forecast) => {
                if (forecast === 0) return 0;
                return ((actual / forecast) - 1) * 100;
            };

            const defaultCell = '---';
            const tbody = $('#cafeSummaryBody');
            tbody.empty();

            if (!summaryData || !summaryData.cafes) {
                // Clear totals
                $('#totalRevenueForecast').text(defaultCell);
                $('#totalTrafficForecast').text(defaultCell);
                $('#totalAvgCheckForecast').text(defaultCell);
                $('#totalRevenueActual').text(defaultCell);
                $('#totalTrafficActual').text(defaultCell);
                $('#totalAvgCheckActual').text(defaultCell);
                $('#totalRevenueTotal').text(defaultCell);
                $('#totalTrafficTotal').text(defaultCell);
                $('#totalAvgCheckTotal').text(defaultCell);
                $('#totalRevenueDeviation').text(defaultCell);
                $('#totalTrafficDeviation').text(defaultCell);
                $('#totalAvgCheckDeviation').text(defaultCell);
                return;
            }

            // Populate cafe rows
            Object.entries(summaryData.cafes).forEach(([cafe, data]) => {
                const revActual = data.revenue.actual || 0;
                const revForecast = data.revenue.forecast || 0;
                const revDelta = revActual - revForecast;  // Дельта = Факт - План
                const trafActual = data.traffic.actual || 0;
                const trafForecast = data.traffic.forecast || 0;
                const trafDelta = trafActual - trafForecast;  // Дельта = Факт - План
                
                const avgCheckActual = trafActual !== 0 ? revActual / trafActual : 0;
                const avgCheckForecast = trafForecast !== 0 ? revForecast / trafForecast : 0;
                const avgCheckDelta = avgCheckActual - avgCheckForecast;  // Дельта = Факт - План
                
                const revDeviation = calculateDeviation(revActual, revForecast);
                const trafDeviation = calculateDeviation(trafActual, trafForecast);
                const checkDeviation = calculateDeviation(avgCheckActual, avgCheckForecast);
                
                const row = $('<tr>');
                row.append($('<td>').text(cafe));
                // План
                row.append($('<td>').addClass('plan-group').text(formatNumber(revForecast, { minimumFractionDigits: 0, maximumFractionDigits: 0 })));
                row.append($('<td>').addClass('plan-group').text(formatNumber(trafForecast, { maximumFractionDigits: 0 })));
                row.append($('<td>').addClass('plan-group').text(formatNumber(avgCheckForecast, { minimumFractionDigits: 0, maximumFractionDigits: 0 })));
                // Факт
                row.append($('<td>').addClass('fact-group').text(formatNumber(revActual, { minimumFractionDigits: 0, maximumFractionDigits: 0 })));
                row.append($('<td>').addClass('fact-group').text(formatNumber(trafActual, { maximumFractionDigits: 0 })));
                row.append($('<td>').addClass('fact-group').text(formatNumber(avgCheckActual, { minimumFractionDigits: 0, maximumFractionDigits: 0 })));
                // Дельта
                row.append($('<td>').addClass('total-group').text(formatNumber(revDelta, { minimumFractionDigits: 0, maximumFractionDigits: 0 })));
                row.append($('<td>').addClass('total-group').text(formatNumber(trafDelta, { maximumFractionDigits: 0 })));
                row.append($('<td>').addClass('total-group').text(formatNumber(avgCheckDelta, { minimumFractionDigits: 0, maximumFractionDigits: 0 })));
                // Отклонение с цветовой индикацией
                const getDeviationClass = (value) => {
                    if (value > 5) return 'deviation-positive';
                    if (value < -5) return 'deviation-negative';
                    return 'deviation-neutral';
                };
                
                row.append($('<td>').addClass('deviation-group').addClass(getDeviationClass(revDeviation))
                    .text(revDeviation !== 0 ? formatNumber(revDeviation, { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%' : '0%'));
                row.append($('<td>').addClass('deviation-group').addClass(getDeviationClass(trafDeviation))
                    .text(trafDeviation !== 0 ? formatNumber(trafDeviation, { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%' : '0%'));
                row.append($('<td>').addClass('deviation-group').addClass(getDeviationClass(checkDeviation))
                    .text(checkDeviation !== 0 ? formatNumber(checkDeviation, { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%' : '0%'));
                tbody.append(row);
            });

            // Update totals
            if (summaryData.total) {
                const totalData = summaryData.total;
                const revActual = totalData.revenue.actual || 0;
                const revForecast = totalData.revenue.forecast || 0;
                const revDelta = revActual - revForecast;  // Дельта = Факт - План
                const trafActual = totalData.traffic.actual || 0;
                const trafForecast = totalData.traffic.forecast || 0;
                const trafDelta = trafActual - trafForecast;  // Дельта = Факт - План
                
                const avgCheckActual = trafActual !== 0 ? revActual / trafActual : 0;
                const avgCheckForecast = trafForecast !== 0 ? revForecast / trafForecast : 0;
                const avgCheckDelta = avgCheckActual - avgCheckForecast;  // Дельта = Факт - План
                
                const revDeviation = calculateDeviation(revActual, revForecast);
                const trafDeviation = calculateDeviation(trafActual, trafForecast);
                const checkDeviation = calculateDeviation(avgCheckActual, avgCheckForecast);
                
                $('#totalRevenueForecast').text(formatNumber(revForecast, { minimumFractionDigits: 0, maximumFractionDigits: 0 }));
                $('#totalTrafficForecast').text(formatNumber(trafForecast, { maximumFractionDigits: 0 }));
                $('#totalAvgCheckForecast').text(formatNumber(avgCheckForecast, { minimumFractionDigits: 0, maximumFractionDigits: 0 }));
                $('#totalRevenueActual').text(formatNumber(revActual, { minimumFractionDigits: 0, maximumFractionDigits: 0 }));
                $('#totalTrafficActual').text(formatNumber(trafActual, { maximumFractionDigits: 0 }));
                $('#totalAvgCheckActual').text(formatNumber(avgCheckActual, { minimumFractionDigits: 0, maximumFractionDigits: 0 }));
                $('#totalRevenueTotal').text(formatNumber(revDelta, { minimumFractionDigits: 0, maximumFractionDigits: 0 }));
                $('#totalTrafficTotal').text(formatNumber(trafDelta, { maximumFractionDigits: 0 }));
                $('#totalAvgCheckTotal').text(formatNumber(avgCheckDelta, { minimumFractionDigits: 0, maximumFractionDigits: 0 }));
                const getDeviationClass = (value) => {
                    if (value > 5) return 'deviation-positive';
                    if (value < -5) return 'deviation-negative';
                    return 'deviation-neutral';
                };
                
                $('#totalRevenueDeviation').text(revDeviation !== 0 ? formatNumber(revDeviation, { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%' : '0%')
                    .removeClass('deviation-positive deviation-negative deviation-neutral').addClass(getDeviationClass(revDeviation));
                $('#totalTrafficDeviation').text(trafDeviation !== 0 ? formatNumber(trafDeviation, { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%' : '0%')
                    .removeClass('deviation-positive deviation-negative deviation-neutral').addClass(getDeviationClass(trafDeviation));
                $('#totalAvgCheckDeviation').text(checkDeviation !== 0 ? formatNumber(checkDeviation, { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%' : '0%')
                    .removeClass('deviation-positive deviation-negative deviation-neutral').addClass(getDeviationClass(checkDeviation));
            }
        }
    </script>
</body>
</html>