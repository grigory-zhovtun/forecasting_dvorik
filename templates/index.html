<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—Ä—É—á–∫–∏ - –ü–∏—Ä–æ–≥–æ–≤—ã–π –î–≤–æ—Ä–∏–∫</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        :root {
            --primary-color: #FF6B6B;
            --secondary-color: #4ECDC4;
            --dark-color: #2C3E50;
            --light-bg: #F7F9FC;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-color);
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: var(--card-shadow);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .main-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .section-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cafe-checkbox {
            background: var(--light-bg);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .cafe-checkbox:hover {
            background: #e8f4f3;
            transform: translateX(5px);
        }

        .cafe-checkbox input[type="checkbox"] {
            width: 1.2rem;
            height: 1.2rem;
            cursor: pointer;
        }

        .cafe-checkbox label {
            cursor: pointer;
            margin-left: 0.5rem;
            font-weight: 500;
        }

        .slider-container {
            margin-bottom: 1.5rem;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .slider-value {
            color: var(--secondary-color);
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--secondary-color);
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--secondary-color);
            cursor: pointer;
            border: none;
        }

        .btn-forecast {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: var(--card-shadow);
        }

        .btn-forecast:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-export {
            background-color: #28a745;
            color: white;
            font-weight: 600;
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .btn-export:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .results-panel {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            min-height: 500px;
        }

        .date-filter {
            background: var(--light-bg);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        .progress-container {
            display: none;
            margin-top: 2rem;
        }

        .progress {
            height: 25px;
            border-radius: 15px;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            transition: width 0.3s ease;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            margin: 2rem 0;
        }


        .badge-metric {
            font-size: 0.85rem;
            padding: 0.3rem 0.8rem;
        }

        /* Enhanced color coding for metrics with more ranges */
        .metric-excellent {
            background-color: #28a745 !important;
            color: white;
            font-weight: 600;
        }

        .metric-good {
            background-color: #5cb85c !important;
            color: white;
        }
        
        .metric-acceptable {
            background-color: #17a2b8 !important;
            color: white;
        }

        .metric-warning {
            background-color: #ffc107 !important;
            color: #212529;
        }

        .metric-poor {
            background-color: #fd7e14 !important;
            color: white;
        }

        .metric-critical {
            background-color: #dc3545 !important;
            color: white;
            font-weight: 600;
        }
        
        .metric-catastrophic {
            background-color: #721c24 !important;
            color: white;
            font-weight: 700;
            animation: pulse-critical 2s infinite;
        }
        
        @keyframes pulse-critical {
            0% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
            }
        }
        
        /* Recommendation popover styling */
        .recommendation-popover {
            max-width: 400px;
            font-size: 0.9rem;
        }
        
        .recommendation-popover .popover-header {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .recommendation-popover .popover-body {
            padding: 1rem;
        }
        
        .recommendation-list {
            margin: 0;
            padding-left: 1.2rem;
        }
        
        .recommendation-list li {
            margin-bottom: 0.5rem;
        }

        #chartContainer {
            min-height: 400px;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            color: #dee2e6;
            margin-bottom: 1rem;
        }

        .toggle-all {
            margin-bottom: 1rem;
        }

        .advanced-settings {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #e9ecef;
        }

        .form-switch {
            padding-left: 3rem;
        }

        .form-switch .form-check-input {
            width: 3rem;
            height: 1.5rem;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .control-panel, .results-panel {
                margin-bottom: 1rem;
            }

            .btn-forecast {
                width: 100%;
            }
        }
        /* Color groups for summary table with enhanced design */
        .fact-group {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
            position: relative;
        }
        
        .plan-group {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%) !important;
            position: relative;
        }
        
        .total-group {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%) !important;
            position: relative;
            font-weight: 600;
        }
        
        .deviation-group {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%) !important;
            position: relative;
        }
        
        /* Additional enhancements for table cells */
        #cafeSummaryTable td {
            transition: all 0.3s ease;
            position: relative;
        }
        
        #cafeSummaryTable tbody tr:hover td {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        #cafeSummaryTable tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.7) !important;
        }
        
        /* Special styling for delta values */
        .total-group {
            position: relative;
        }
        
        .total-group:before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 60%;
            background: #4caf50;
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        tr:hover .total-group:before {
            opacity: 1;
        }
        
        /* Deviation styling with color indicators */
        .deviation-group {
            font-weight: 600;
        }
        
        .deviation-positive {
            color: #2e7d32;
        }
        
        .deviation-negative {
            color: #c62828;
        }
        
        .deviation-neutral {
            color: #757575;
        }
        
        thead th.fact-group,
        thead th.plan-group,
        thead th.total-group,
        thead th.deviation-group {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
            padding: 1rem;
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
        }
        
        /* Header hover effects */
        thead th:hover {
            background-color: rgba(255, 255, 255, 0.3) !important;
        }
        
        /* Summary table border styling */
        #cafeSummaryTable {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        #cafeSummaryTable thead tr:first-child th:first-child {
            border-top-left-radius: 10px;
        }
        
        #cafeSummaryTable thead tr:first-child th:last-child {
            border-top-right-radius: 10px;
        }
        
        /* Footer styling */
        #cafeSummaryTable tfoot {
            font-weight: 700;
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
        }
        
        #cafeSummaryTable tfoot td {
            border-top: 3px solid #bdbdbd;
            padding: 1rem;
        }
        
        tbody td.fact-group,
        tbody td.plan-group,
        tbody td.total-group,
        tbody td.deviation-group {
            background-color: inherit;
            padding: 0.875rem;
        }
        
        tfoot td.fact-group,
        tfoot td.plan-group,
        tfoot td.total-group,
        tfoot td.deviation-group {
            background-color: transparent !important;
        }
        
        /* Pulse animation for important values */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }
        
        .important-value {
            animation: pulse 2s infinite;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫ */
        .adjustment-item {
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }
        
        .adjustment-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }
        
        .adjustment-item .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="bi bi-graph-up"></i> –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—Ä—É—á–∫–∏ - –ü–∏—Ä–æ–≥–æ–≤—ã–π –î–≤–æ—Ä–∏–∫
            </span>
        </div>
    </nav>

    <div class="container-fluid main-container">
        <div class="row">
            <div class="col-lg-3">
                <div class="control-panel">
                    <h3 class="section-title">
                        <i class="bi bi-sliders"></i> –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–≥–Ω–æ–∑–∞
                    </h3>

                    <div class="mb-4">
                        <h5 class="mb-3">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ñ–µ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞</h5>
                        <div class="toggle-all">
                            <button class="btn btn-sm btn-outline-secondary" id="selectAll">
                                <i class="bi bi-check-square"></i> –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="deselectAll">
                                <i class="bi bi-square"></i> –°–Ω—è—Ç—å –≤—Å–µ
                            </button>
                        </div>
                        <div id="cafeList" class="cafe-list" style="max-height: 300px; overflow-y: auto;">
                            </div>
                    </div>

                    <div class="mb-4">
                        <h5 class="mb-3">–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h5>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>–ì–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ (–¥–Ω–µ–π)</span>
                                <span class="slider-value" id="horizonValue">365</span>
                            </div>
                            <input type="range" id="forecastHorizon" min="30" max="730" value="365" step="30" data-bs-toggle="tooltip" title="–ü–µ—Ä–∏–æ–¥, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∞–µ—Ç—Å—è –ø—Ä–æ–≥–Ω–æ–∑">
                        </div>


                        <div class="slider-container">
                            <div class="slider-label">
                                <span>–î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (%)</span>
                                <span class="slider-value" id="confIntervalValue">95</span>
                            </div>
                            <input type="range" id="confInterval" min="50" max="99" value="95" step="1" data-bs-toggle="tooltip" title="–£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞. –ù–∞–ø—Ä–∏–º–µ—Ä, 95% –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –æ–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ø–∞–¥–µ—Ç –≤ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –≤ 95% —Å–ª—É—á–∞–µ–≤.">
                        </div>
                    </div>

                    <div class="advanced-settings">
                        <h5 class="mb-3">
                            <i class="bi bi-gear"></i> –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                        </h5>

                        <div class="form-check form-switch mb-4">
                            <input class="form-check-input" type="checkbox" id="autoTune" data-bs-toggle="tooltip" title="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–∏—Ä–∞–µ—Ç –ª—É—á—à–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏, –Ω–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏.">
                            <label class="form-check-label" for="autoTune">
                                –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                            </label>
                            <small class="form-text text-muted d-block mt-1">
                                –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Optuna –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –º–æ–¥–µ–ª–∏
                            </small>
                        </div>
                        
                        <div class="slider-container mb-4">
                            <div class="slider-label">
                                <span>–î–æ–ª—è –æ–±—É—á–∞—é—â–µ–π –≤—ã–±–æ—Ä–∫–∏ (%)</span>
                                <span class="slider-value" id="trainSplitValue">80</span>
                            </div>
                            <input type="range" id="trainSplit" min="50" max="90" value="80" step="5" data-bs-toggle="tooltip" title="–ü—Ä–æ—Ü–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏.">
                            <small class="form-text text-muted d-block mt-1">
                                –ß–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ (50-90%)
                            </small>
                        </div>
                    
                        <div class="mb-4">
                            <label for="modelType" class="form-label">–ú–æ–¥–µ–ª—å –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è</label>
                            <select class="form-select" id="modelType" data-bs-toggle="tooltip" title="Prophet: —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å. ARIMA: –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. XGBoost: –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π. LSTM: –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ —Å —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å—é.">
                                <option value="prophet" selected>Prophet</option>
                                <option value="arima">ARIMA</option>
                                <option value="xgboost">XGBoost</option>
                                <option value="lstm">LSTM (–Ω–µ–π—Ä–æ–Ω–Ω–∞—è —Å–µ—Ç—å)</option>
                            </select>
                            <small class="text-muted mt-1 d-block">
                                –í—ã–±–µ—Ä–∏—Ç–µ –∞–ª–≥–æ—Ä–∏—Ç–º, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è
                            </small>
                        </div>
                    
                    </div>


                    <div class="mt-4" id="adjustmentsSection" style="display: none;">
                        <h5 class="mb-3">
                            <i class="bi bi-sliders2-vertical"></i> –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
                        </h5>
                        <div id="adjustmentsContainer">
                            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                    </div>

                    <div class="mt-4 text-center">
                        <button class="btn btn-forecast" id="runForecast">
                            <i class="bi bi-play-circle"></i> –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑
                        </button>
                        <button class="btn btn-danger ms-2" id="cancelForecast" style="display: none;">
                            <i class="bi bi-stop-circle"></i> –ü—Ä–µ—Ä–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é
                        </button>
                    </div>

                    <div class="progress-container" id="progressContainer">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar"
                                 id="progressBar"
                                 style="width: 0%">
                                <span id="progressText">0%</span>
                            </div>
                        </div>
                        <div class="text-center mt-2">
                            <small id="progressMessage" class="text-muted"></small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-9">
                <div class="results-panel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="section-title mb-0">
                            <i class="bi bi-graph-up-arrow"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≥–Ω–æ–∑–∞
                        </h3>
                        <button class="btn btn-export" id="exportExcel" style="display: none;">
                            <i class="bi bi-file-earmark-excel"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                        </button>
                    </div>

                    <div class="date-filter" id="dateFilter" style="display: none;">
                        <div class="row align-items-end mb-3">
                            <div class="col-md-8">
                                <div class="btn-group" role="group" aria-label="–¢–∏–ø –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è">
                                    <input type="radio" class="btn-check" name="viewType" id="lineChart" value="line" checked>
                                    <label class="btn btn-outline-primary" for="lineChart">
                                        <i class="bi bi-graph-up"></i> –ì—Ä–∞—Ñ–∏–∫ –ø–æ –¥–Ω—è–º
                                    </label>
                                    <input type="radio" class="btn-check" name="viewType" id="barChart" value="bar">
                                    <label class="btn btn-outline-primary" for="barChart">
                                        <i class="bi bi-bar-chart"></i> –°—Ç–æ–ª–±—Ü—ã –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º
                                    </label>
                                </div>
                                <div class="d-inline-block ms-3" id="aggregationPeriodContainer" style="display: none;">
                                    <label for="aggregationPeriod" class="form-label d-inline me-2">–ü–µ—Ä–∏–æ–¥ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏:</label>
                                    <select class="form-select d-inline-block w-auto" id="aggregationPeriod">
                                        <option value="month" selected>–ú–µ—Å—è—Ü</option>
                                        <option value="quarter">–ö–≤–∞—Ä—Ç–∞–ª</option>
                                        <option value="halfyear">–ü–æ–ª—É–≥–æ–¥–∏–µ</option>
                                        <option value="year">–ì–æ–¥</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-primary" id="updateChart">
                                    <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫
                                </button>
                            </div>
                        </div>
                        <div class="row align-items-end">
                            <div class="col-md-4" id="monthNavigationContainer" style="display: block;">
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-secondary" id="prevMonth">
                                        <i class="bi bi-chevron-left"></i> –ü—Ä–µ–¥. –º–µ—Å—è—Ü
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="currentMonth" disabled style="flex: 1;">
                                        <span id="currentMonthText">–ú–µ—Å—è—Ü</span>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="nextMonth">
                                        –°–ª–µ–¥. –º–µ—Å—è—Ü <i class="bi bi-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="dateFrom" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                                <input type="date" class="form-control" id="dateFrom">
                            </div>
                            <div class="col-md-4">
                                <label for="dateTo" class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                                <input type="date" class="form-control" id="dateTo">
                            </div>
                        </div>
                    </div>

                    <div id="chartContainer">
                        <div class="empty-state">
                            <i class="bi bi-graph-up"></i>
                            <h5>–ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω –ø—Ä–æ–≥–Ω–æ–∑</h5>
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ñ–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑"</p>
                        </div>
                    </div>

                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="mt-2">–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞...</p>
                    </div>

                    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–∞–±—ã -->
                    <ul class="nav nav-tabs mt-4" id="resultTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">
                                <i class="bi bi-card-list"></i> –°–≤–æ–¥–∫–∞
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="metrics-tab" data-bs-toggle="tab" data-bs-target="#metrics" type="button" role="tab">
                                <i class="bi bi-bar-chart-line"></i> –ú–µ—Ç—Ä–∏–∫–∏
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                                <i class="bi bi-gear"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∞
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="passport-tab" data-bs-toggle="tab" data-bs-target="#passport" type="button" role="tab">
                                <i class="bi bi-building"></i> –ü–∞—Å–ø–æ—Ä—Ç
                            </button>
                        </li>
                    </ul>

                    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–±–æ–≤ -->
                    <div class="tab-content" id="resultTabsContent">
                        <!-- –¢–∞–± –°–≤–æ–¥–∫–∞ -->
                        <div class="tab-pane fade show active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
                            <div id="summaryTableContainer" class="mt-4">
                                <div class="table-responsive">
                            <table class="table table-bordered table-striped" id="cafeSummaryTable">
                                <thead class="table-light">
                                    <tr>
                                        <th rowspan="2">–ö–∞—Ñ–µ</th>
                                        <th colspan="3" class="text-center plan-group">–ü–ª–∞–Ω</th>
                                        <th colspan="3" class="text-center fact-group">–§–∞–∫—Ç</th>
                                        <th colspan="3" class="text-center total-group">–î–µ–ª—å—Ç–∞</th>
                                        <th colspan="3" class="text-center deviation-group">–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ</th>
                                    </tr>
                                    <tr>
                                        <th class="plan-group">–í—ã—Ä—É—á–∫–∞</th>
                                        <th class="plan-group">–¢—Ä–∞—Ñ–∏–∫</th>
                                        <th class="plan-group">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</th>
                                        <th class="fact-group">–í—ã—Ä—É—á–∫–∞</th>
                                        <th class="fact-group">–¢—Ä–∞—Ñ–∏–∫</th>
                                        <th class="fact-group">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</th>
                                        <th class="total-group">–í—ã—Ä—É—á–∫–∞</th>
                                        <th class="total-group">–¢—Ä–∞—Ñ–∏–∫</th>
                                        <th class="total-group">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</th>
                                        <th class="deviation-group">–í—ã—Ä—É—á–∫–∞, %</th>
                                        <th class="deviation-group">–¢—Ä–∞—Ñ–∏–∫, %</th>
                                        <th class="deviation-group">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫, %</th>
                                    </tr>
                                </thead>
                                <tbody id="cafeSummaryBody">
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <th>–ò—Ç–æ–≥–æ</th>
                                        <td id="totalRevenueForecast" class="plan-group">---</td>
                                        <td id="totalTrafficForecast" class="plan-group">---</td>
                                        <td id="totalAvgCheckForecast" class="plan-group">---</td>
                                        <td id="totalRevenueActual" class="fact-group">---</td>
                                        <td id="totalTrafficActual" class="fact-group">---</td>
                                        <td id="totalAvgCheckActual" class="fact-group">---</td>
                                        <td id="totalRevenueTotal" class="total-group">---</td>
                                        <td id="totalTrafficTotal" class="total-group">---</td>
                                        <td id="totalAvgCheckTotal" class="total-group">---</td>
                                        <td id="totalRevenueDeviation" class="deviation-group">---</td>
                                        <td id="totalTrafficDeviation" class="deviation-group">---</td>
                                        <td id="totalAvgCheckDeviation" class="deviation-group">---</td>
                                    </tr>
                                </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- –¢–∞–± –ú–µ—Ç—Ä–∏–∫–∏ -->
                        <div class="tab-pane fade" id="metrics" role="tabpanel" aria-labelledby="metrics-tab">
                            <div id="metricsContainer" class="mt-4">
                        <h4 class="mb-3 section-title"><i class="bi bi-bar-chart-line"></i> –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞</h4>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>–ö–∞—Ñ–µ</th>
                                        <th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th>
                                        <th>MAPE, %</th>
                                        <th>MAE</th>
                                        <th>RMSE</th>
                                        <th>R¬≤</th>
                                        <th>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</th>
                                    </tr>
                                </thead>
                                <tbody id="metricsTable">
                                </tbody>
                            </table>
                                </div>
                                <div class="mt-4 p-3 bg-light rounded">
                                    <h5>–°–ø—Ä–∞–≤–∫–∞ –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º:</h5>
                                    <ul class="mb-0" style="font-size: 0.9rem;">
                                        <li class="mb-2"><strong>MAPE, %</strong> ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞ —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –≤ —Å—Ä–µ–¥–Ω–µ–º –ø—Ä–æ–≥–Ω–æ–∑ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ñ–∞–∫—Ç–∞.
                                            <br>üìå –ï—Å–ª–∏ MAPE = 10% –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏, —ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –ø—Ä–∏ —Å—Ä–µ–¥–Ω–µ–º –¥–æ—Ö–æ–¥–µ 25 000 000 ‚ÇΩ –≤ –º–µ—Å—è—Ü, –º—ã –≤ —Å—Ä–µ–¥–Ω–µ–º –æ—à–∏–±–∞–µ–º—Å—è –Ω–∞ 2 500 000 ‚ÇΩ.
                                            <br>üìå –ï—Å–ª–∏ MAPE = 10% –¥–ª—è –ü–î-01, –æ—à–∏–±–∫–∞ —Å–æ—Å—Ç–∞–≤–∏—Ç –æ–∫–æ–ª–æ 200 000 ‚ÇΩ –≤ –º–µ—Å—è—Ü.
                                        </li>
                                        <li class="mb-2"><strong>MAE</strong> ‚Äî —Å—Ä–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞ –≤ —Ä—É–±–ª—è—Ö: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞ —Å–∫–æ–ª—å–∫–æ —Ä—É–±–ª–µ–π –º—ã –æ–±—ã—á–Ω–æ –æ—à–∏–±–∞–µ–º—Å—è.
                                            <br>üìå MAE = 1 000 000 ‚ÇΩ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ ‚Äî –∑–Ω–∞—á–∏—Ç, –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü –º—ã –æ—à–∏–±–∞–µ–º—Å—è –≤ –ø—Ä–æ–≥–Ω–æ–∑–µ –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ –º–∏–ª–ª–∏–æ–Ω, –∏–Ω–æ–≥–¥–∞ –≤—ã—à–µ, –∏–Ω–æ–≥–¥–∞ –Ω–∏–∂–µ.
                                            <br>üìå MAE = 150 000 ‚ÇΩ –¥–ª—è –ü–î-01 ‚Äî –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –≤ —Å—Ä–µ–¥–Ω–µ–º –º—ã –Ω–µ —É–≥–∞–¥—ã–≤–∞–µ–º –Ω–∞ 150 000 ‚ÇΩ.
                                        </li>
                                        <li class="mb-2"><strong>RMSE</strong> ‚Äî —Ç–æ–∂–µ –æ—à–∏–±–∫–∞ –≤ —Ä—É–±–ª—è—Ö, –Ω–æ –æ–Ω–∞ —Å–∏–ª—å–Ω–µ–µ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –±–æ–ª—å—à–∏–µ –ø—Ä–æ–º–∞—Ö–∏.
                                            <br>üìå –ï—Å–ª–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—è—Ü–µ –ø—Ä–æ–≥–Ω–æ–∑ –¥–æ—Å—Ç–∞–≤–∫–∏ –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è –Ω–∞ 5 000 000 ‚ÇΩ, RMSE –≤—ã—Ä–∞—Å—Ç–µ—Ç –±–æ–ª—å—à–µ, —á–µ–º MAE, –∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–∫–∞–∂–µ—Ç 1 800 000 ‚ÇΩ.
                                            <br>üìå –î–ª—è –ü–î-01, –µ—Å–ª–∏ –±—ã–ª –æ–¥–∏–Ω –∫—Ä—É–ø–Ω—ã–π –ø—Ä–æ–º–∞—Ö, RMSE –º–æ–∂–µ—Ç –±—ã—Ç—å 250 000 ‚ÇΩ, –¥–∞–∂–µ –µ—Å–ª–∏ MAE ‚Äî 150 000 ‚ÇΩ.
                                        </li>
                                        <li><strong>R¬≤</strong> ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–æ –º–æ–¥–µ–ª—å "–ø–æ–Ω–∏–º–∞–µ—Ç" –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤—ã—Ä—É—á–∫–∏.
                                            <br>üìå –ï—Å–ª–∏ R¬≤ = 0.9 —É –¥–æ—Å—Ç–∞–≤–∫–∏ ‚Äî —ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –º–æ–¥–µ–ª—å –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–∞—á–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –∞–∫—Ü–∏–π –∏–ª–∏ –ø–ª–æ—Ö–æ–π –ø–æ–≥–æ–¥—ã) –¥–æ–≤–æ–ª—å–Ω–æ —Ç–æ—á–Ω–æ.
                                            <br>üìå –ï—Å–ª–∏ —É –ü–î-01 R¬≤ = 0.5 ‚Äî –º–æ–¥–µ–ª—å —É–≥–∞–¥—ã–≤–∞–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ö—É–∂–µ, –Ω–µ –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏—Ç –ø—Ä–∏—á–∏–Ω—ã —Ä–æ—Å—Ç–∞ –∏–ª–∏ —Å–ø–∞–¥–∞ –≤—ã—Ä—É—á–∫–∏.
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- –¢–∞–± –ù–∞—Å—Ç—Ä–æ–π–∫–∞ -->
                        <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                            <div id="settingsContainer" class="mt-4">
                                <h4 class="mb-3 section-title"><i class="bi bi-gear"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø–æ –∫–∞—Ñ–µ</h4>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="settingsTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th rowspan="2" style="vertical-align: middle;">–ö–∞—Ñ–µ</th>
                                                <th colspan="3" class="text-center">–°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å</th>
                                                <th colspan="2" class="text-center">–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏</th>
                                                <th rowspan="2" style="vertical-align: middle;">–£—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫–∏</th>
                                                <th rowspan="2" style="vertical-align: middle;">–£–¥–∞–ª—è—Ç—å –≤—ã–±—Ä–æ—Å—ã</th>
                                            </tr>
                                            <tr>
                                                <th>–ì–æ–¥–æ–≤–∞—è</th>
                                                <th>–ù–µ–¥–µ–ª—å–Ω–∞—è</th>
                                                <th>–î–Ω–µ–≤–Ω–∞—è</th>
                                                <th>–ö —Ç—Ä–µ–Ω–¥—É</th>
                                                <th>–ö —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏</th>
                                            </tr>
                                        </thead>
                                        <tbody id="settingsTableBody">
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-primary" id="applySettings">
                                        <i class="bi bi-check-circle"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                                    </button>
                                    <button class="btn btn-secondary ms-2" id="resetSettings">
                                        <i class="bi bi-arrow-counterclockwise"></i> –°–±—Ä–æ—Å–∏—Ç—å –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ
                                    </button>
                                </div>
                                <div class="mt-4 p-3 bg-light rounded">
                                    <h5>–ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º:</h5>
                                    <ul class="mb-0">
                                        <li><strong>–°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å:</strong> –í–∫–ª—é—á–∏—Ç–µ —Ç–µ —Ç–∏–ø—ã —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–∞—Ñ–µ</li>
                                        <li><strong>–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ —Ç—Ä–µ–Ω–¥—É (0.001-0.5):</strong> –ß–µ–º –≤—ã—à–µ –∑–Ω–∞—á–µ–Ω–∏–µ, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ –º–æ–¥–µ–ª—å —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç—Ä–µ–Ω–¥–∞</li>
                                        <li><strong>–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏ (0.1-25):</strong> –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–∏–ª—É —Å–µ–∑–æ–Ω–Ω—ã—Ö –∫–æ–ª–µ–±–∞–Ω–∏–π</li>
                                        <li><strong>–£—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫–∏:</strong> –í–∫–ª—é—á–∏—Ç–µ –¥–ª—è –∫–∞—Ñ–µ –≤ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ü–µ–Ω—Ç—Ä–∞—Ö –∏ –º–µ—Å—Ç–∞—Ö —Å –≤—ã—Å–æ–∫–∏–º —Ç—Ä–∞—Ñ–∏–∫–æ–º</li>
                                        <li><strong>–£–¥–∞–ª—è—Ç—å –≤—ã–±—Ä–æ—Å—ã:</strong> –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã, –æ—Ç–∫–ª—é—á–∏—Ç–µ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–∞—Ñ–µ</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- –¢–∞–± –ü–∞—Å–ø–æ—Ä—Ç -->
                        <div class="tab-pane fade" id="passport" role="tabpanel" aria-labelledby="passport-tab">
                            <div id="passportContainer" class="mt-4">
                                <h4 class="mb-3 section-title"><i class="bi bi-building"></i> –ü–∞—Å–ø–æ—Ä—Ç –∫–∞—Ñ–µ</h4>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="passportTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th>–ö–∞—Ñ–µ</th>
                                                <th>–î–∞—Ç–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è</th>
                                                <th>–î–Ω–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç</th>
                                                <th>–ü–æ—Å–∞–¥–æ—á–Ω—ã—Ö –º–µ—Å—Ç</th>
                                                <th>–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</th>
                                                <th>–®—Ç–∞—Ç</th>
                                                <th>–ü–ª–æ—â–∞–¥—å, –º¬≤</th>
                                                <th>–ü–∞—Ä–∫–æ–≤–∫–∞</th>
                                                <th>–î–æ—Å—Ç–∞–≤–∫–∞</th>
                                                <th>–ß–µ–∫–æ–≤/—Å–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                                <th>–¢–û/—Å–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                            </tr>
                                        </thead>
                                        <tbody id="passportTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let cafes = [];
        let forecastData = null;
        let cancelRequested = false;
        let currentViewType = 'line';
        let currentAggregationPeriod = 'month';
        let currentMonth = new Date();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        $(document).ready(function() {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
            loadInitialData();
            setupEventHandlers();
            loadPassportData();
            
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            $('#aggregationPeriodContainer').hide();
            $('#monthNavigationContainer').show();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—É–ª—Ç–∏–ø–æ–≤ Bootstrap
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Å–ø–æ—Ä—Ç–∞
        function loadPassportData() {
            $.get('/api/passport_data', function(response) {
                if (response.passport_data && response.passport_data.length > 0) {
                    const tbody = $('#passportTableBody');
                    tbody.empty();
                    
                    response.passport_data.forEach(cafe => {
                        const row = $(`
                            <tr>
                                <td><strong>${cafe.cafe}</strong></td>
                                <td>${new Date(cafe.open_date).toLocaleDateString('ru-RU')}</td>
                                <td>${cafe.days_working}</td>
                                <td>${cafe.seats}</td>
                                <td>${cafe.location_type}</td>
                                <td>${cafe.staff_count}</td>
                                <td>${cafe.area_sqm}</td>
                                <td>${cafe.parking}</td>
                                <td>${cafe.delivery}</td>
                                <td>${cafe.checks_per_staff}</td>
                                <td>${cafe.revenue_per_staff.toLocaleString('ru-RU')} ‚ÇΩ</td>
                            </tr>
                        `);
                        tbody.append(row);
                    });
                }
            }).fail(function(error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Å–ø–æ—Ä—Ç–∞:', error);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ –∫–∞—Ñ–µ
        function loadCafeSettings() {
            const tbody = $('#settingsTableBody');
            tbody.empty();
            
            // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const defaultSettings = {
                yearly_seasonality: true,
                weekly_seasonality: true,
                daily_seasonality: false,
                changepoint_prior_scale: 0.05,
                seasonality_prior_scale: 10.0,
                holidays_enabled: true,
                remove_outliers: true
            };
            
            cafes.forEach(cafe => {
                const row = $(`
                    <tr data-cafe="${cafe}">
                        <td><strong>${cafe}</strong></td>
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input yearly-season" ${defaultSettings.yearly_seasonality ? 'checked' : ''}>
                        </td>
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input weekly-season" ${defaultSettings.weekly_seasonality ? 'checked' : ''}>
                        </td>
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input daily-season" ${defaultSettings.daily_seasonality ? 'checked' : ''}>
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm trend-scale" 
                                   value="${defaultSettings.changepoint_prior_scale}" 
                                   min="0.001" max="0.5" step="0.001"
                                   data-bs-toggle="tooltip" title="–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 0.05 –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –∫–∞—Ñ–µ, 0.1-0.2 –¥–ª—è –Ω–æ–≤—ã—Ö">
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm seasonality-scale" 
                                   value="${defaultSettings.seasonality_prior_scale}" 
                                   min="0.1" max="25" step="0.1"
                                   data-bs-toggle="tooltip" title="–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 10 –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∫–∞—Ñ–µ, 20 –¥–ª—è –∫–∞—Ñ–µ —Å –≤—ã—Å–æ–∫–æ–π —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å—é">
                        </td>
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input holidays-enabled" ${defaultSettings.holidays_enabled ? 'checked' : ''}>
                        </td>
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input outliers-enabled" ${defaultSettings.remove_outliers ? 'checked' : ''}>
                        </td>
                    </tr>
                `);
                tbody.append(row);
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—É–ª—Ç–∏–ø–æ–≤
            $('[data-bs-toggle="tooltip"]').tooltip();
        }
        
        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function applyCafeSettings() {
            const settings = {};
            
            $('#settingsTableBody tr').each(function() {
                const row = $(this);
                const cafe = row.data('cafe');
                
                settings[cafe] = {
                    yearly_seasonality: row.find('.yearly-season').is(':checked'),
                    weekly_seasonality: row.find('.weekly-season').is(':checked'),
                    daily_seasonality: row.find('.daily-season').is(':checked'),
                    changepoint_prior_scale: parseFloat(row.find('.trend-scale').val()),
                    seasonality_prior_scale: parseFloat(row.find('.seasonality-scale').val()),
                    holidays_enabled: row.find('.holidays-enabled').is(':checked'),
                    remove_outliers: row.find('.outliers-enabled').is(':checked')
                };
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ localStorage
            localStorage.setItem('cafeSettings', JSON.stringify(settings));
            alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ MAPE
        function getMapeColorClass(mapeValue) {
            if (mapeValue <= 5) {
                return 'metric-excellent';      // –û—Ç–ª–∏—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑
            } else if (mapeValue <= 10) {
                return 'metric-good';           // –•–æ—Ä–æ—à–∏–π –ø—Ä–æ–≥–Ω–æ–∑
            } else if (mapeValue <= 15) {
                return 'metric-acceptable';     // –ü—Ä–∏–µ–º–ª–µ–º—ã–π –ø—Ä–æ–≥–Ω–æ–∑
            } else if (mapeValue <= 20) {
                return 'metric-warning';        // –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è
            } else if (mapeValue <= 30) {
                return 'metric-poor';           // –ü–ª–æ—Ö–æ–π –ø—Ä–æ–≥–Ω–æ–∑
            } else if (mapeValue <= 40) {
                return 'metric-critical';       // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑
            } else {
                return 'metric-catastrophic';   // –ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function loadInitialData() {
            console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');
            $.get('/api/get_initial_data', function(data) {
                console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);
                cafes = data.cafes;
                renderCafeList();
                loadCafeSettings();

                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç
                if (data.date_range) {
                    $('#dateFrom').attr('min', data.date_range.min);
                    $('#dateTo').attr('max', new Date(new Date(data.date_range.max).getTime() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
                }
                 // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ –∏–∑ data.default_params
                if (data.default_params) {
                    $('#forecastHorizon').val(data.default_params.forecast_horizon);
                    $('#horizonValue').text(data.default_params.forecast_horizon);

                    // –£–¥–∞–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ remove_outliers –∏ outlier_multiplier
                    
                    if (data.default_params.confidence_interval) {
                        $('#confInterval').val(data.default_params.confidence_interval * 100);
                        $('#confIntervalValue').text(data.default_params.confidence_interval * 100);
                    }

                    // –£–¥–∞–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Prophet - —Ç–µ–ø–µ—Ä—å –±–µ—Ä—É—Ç—Å—è –∏–∑ –≤–∫–ª–∞–¥–∫–∏ –ù–∞—Å—Ç—Ä–æ–π–∫–∞
                }
                
            }).fail(function(error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É.');
            });
        }
        

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–∞—Ñ–µ
        function renderCafeList() {
            const container = $('#cafeList');
            container.empty();

            cafes.forEach((cafe, index) => {
                const item = $(`
                    <div class="cafe-checkbox">
                        <div class="form-check">
                            <input class="form-check-input cafe-select" type="checkbox"
                                   value="${cafe}" id="cafe${index}">
                            <label class="form-check-label" for="cafe${index}">
                                ${cafe}
                            </label>
                        </div>
                    </div>
                `);
                container.append(item);
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –º–µ—Å—è—Ü–∞–º
        function updateMonthNavigation() {
            const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', 
                              '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
            const monthText = monthNames[currentMonth.getMonth()] + ' ' + currentMonth.getFullYear();
            $('#currentMonthText').text(monthText);
        }

        function setDatesForCurrentMonth() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            $('#dateFrom').val(firstDay.toISOString().split('T')[0]);
            $('#dateTo').val(lastDay.toISOString().split('T')[0]);
        }
        
        function updateMonthIndicatorFromDates() {
            const dateFrom = $('#dateFrom').val();
            const dateTo = $('#dateTo').val();
            
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                const toDate = dateTo ? new Date(dateTo) : fromDate;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–∫—Ä—ã–≤–∞—é—Ç –ª–∏ –¥–∞—Ç—ã –ø–æ–ª–Ω—ã–π –º–µ—Å—è—Ü
                const firstDay = new Date(fromDate.getFullYear(), fromDate.getMonth(), 1);
                const lastDay = new Date(fromDate.getFullYear(), fromDate.getMonth() + 1, 0);
                
                if (fromDate.getTime() === firstDay.getTime() && 
                    toDate.getTime() === lastDay.getTime()) {
                    // –≠—Ç–æ –ø–æ–ª–Ω—ã–π –º–µ—Å—è—Ü, –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                    currentMonth = new Date(fromDate);
                    updateMonthNavigation();
                }
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞—Ñ–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫
        function updateAdjustmentCafeList() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å–µ–ª–µ–∫—Ç—ã –∫–∞—Ñ–µ –≤ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞—Ö
            $('.adj-cafe').each(function() {
                const select = $(this);
                const currentValue = select.val();
                select.empty();
                select.append('<option value="ALL">–í—Å–µ –∫–∞—Ñ–µ</option>');
                cafes.forEach(cafe => {
                    select.append(`<option value="${cafe}">${cafe}</option>`);
                });
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                if (currentValue) {
                    select.val(currentValue);
                }
            });
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
            $("#modelType").off('change').on('change', function() {
                const modelType = $(this).val();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
                const modelInfo = {
                    'prophet': 'Facebook Prophet - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤',
                    'arima': 'ARIMA - –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å, –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö',
                    'xgboost': 'XGBoost - –º–æ—â–Ω–∞—è –º–æ–¥–µ–ª—å –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è, —Ö–æ—Ä–æ—à–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ —Å–ª–æ–∂–Ω—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏',
                    'lstm': 'LSTM - –Ω–µ–π—Ä–æ–Ω–Ω–∞—è —Å–µ—Ç—å, –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ —Å —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å—é'
                };
                
                $(this).next('small').text(modelInfo[modelType]);
            });
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventHandlers() {
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫
            // –°–ª–∞–π–¥–µ—Ä—ã
            $('#forecastHorizon').on('input', function() {
                $('#horizonValue').text($(this).val());
            });

            $('#confInterval').on('input', function() {
                $('#confIntervalValue').text($(this).val());
            });

            // –í—ã–±—Ä–∞—Ç—å/—Å–Ω—è—Ç—å –≤—Å–µ
            $('#selectAll').click(function() {
                $('.cafe-select').prop('checked', true);
            });
            
            $("#trainSplit").on("input", function() {
                $("#trainSplitValue").text($(this).val());
            });

            $('#deselectAll').click(function() {
                $('.cafe-select').prop('checked', false);
            });

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏

            // –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è
            $('#runForecast').click(runForecast);

            // –û—Ç–º–µ–Ω–∞ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è
            $('#cancelForecast').click(function() {
                cancelRequested = true;
                $(this).prop('disabled', true).text('–û—Ç–º–µ–Ω—è–µ—Ç—Å—è...');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ–Ω—É
                $.ajax({
                    url: '/api/cancel_forecast',
                    method: 'POST',
                    success: function() {
                        console.log('–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
                    }
                });
            });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
            $('#updateChart').click(updateChart);

            // –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
            $('#exportExcel').click(function() {
                window.location.href = '/api/export_excel';
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∏–ø–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            $('input[name="viewType"]').change(function() {
                currentViewType = $(this).val();
                if (currentViewType === 'bar') {
                    $('#aggregationPeriodContainer').show();
                    $('#monthNavigationContainer').hide();
                } else {
                    $('#aggregationPeriodContainer').hide();
                    $('#monthNavigationContainer').show();
                }
                updateChart();
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç –≤—Ä—É—á–Ω—É—é
            $('#dateFrom, #dateTo').change(function() {
                updateMonthIndicatorFromDates();
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
            $('#aggregationPeriod').change(function() {
                currentAggregationPeriod = $(this).val();
                updateChart();
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –º–µ—Å—è—Ü–∞–º
            $('#prevMonth').click(function() {
                currentMonth.setMonth(currentMonth.getMonth() - 1);
                updateMonthNavigation();
                setDatesForCurrentMonth();
                updateChart();
            });

            $('#nextMonth').click(function() {
                currentMonth.setMonth(currentMonth.getMonth() + 1);
                updateMonthNavigation();
                setDatesForCurrentMonth();
                updateChart();
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            $('#applySettings').click(function() {
                applyCafeSettings();
            });

            $('#resetSettings').click(function() {
                if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ?')) {
                    localStorage.removeItem('cafeSettings');
                    loadCafeSettings();
                    alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ');
                }
            });
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫

        // –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è
        function runForecast() {
            const selectedCafes = $('.cafe-select:checked').map(function() {
                return $(this).val();
            }).get();

            if (selectedCafes.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∫–∞—Ñ–µ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞');
                return;
            }

            console.log('–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ñ–µ:', selectedCafes);

            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ –∫–∞—Ñ–µ –∏–∑ localStorage –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
            const savedSettings = localStorage.getItem('cafeSettings');
            const cafeSettings = savedSettings ? JSON.parse(savedSettings) : {};
            
            const params = {
                cafes: selectedCafes,
                forecast_horizon: parseInt($('#forecastHorizon').val()),
                confidence_interval: parseFloat($('#confInterval').val()) / 100,
                // Model specific parameters
                model_type: $('#modelType').val(),
                auto_tune: $('#autoTune').is(':checked'),
                train_split: parseFloat($('#trainSplit').val()) / 100,
                // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ –∫–∞—Ñ–µ –∏–∑ –≤–∫–ª–∞–¥–∫–∏ –ù–∞—Å—Ç—Ä–æ–π–∫–∞
                cafe_settings: cafeSettings
            };

            // Add display date filters to params if they are set
            const displayDateFrom = $('#dateFrom').val();
            if (displayDateFrom) {
                params.date_filter_from = displayDateFrom;
            }

            const displayDateTo = $('#dateTo').val();
            if (displayDateTo) {
                params.date_filter_to = displayDateTo;
            }

            console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–≥–Ω–æ–∑–∞:', params);

            // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
            $('#progressContainer').show();
            $('#runForecast').prop('disabled', true);
            $('#cancelForecast').show().prop('disabled', false).text('–ü—Ä–µ—Ä–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é');
            cancelRequested = false;

            // –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è
            $.ajax({
                url: '/api/forecast',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(params),
                success: function(response) {
                    console.log('–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ:', response);
                    // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                    monitorProgress();
                },
                error: function(xhr, status, error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è: ' + (xhr.responseJSON ? xhr.responseJSON.error : error) );
                    $('#progressContainer').hide();
                    $('#runForecast').prop('disabled', false);
                }
            });
        }

        // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function monitorProgress() {
            const interval = setInterval(function() {
                if (cancelRequested) {
                    clearInterval(interval);
                    $('#progressContainer').hide();
                    $('#runForecast').prop('disabled', false);
                    $('#cancelForecast').hide();
                    $('#progressBar').css('width', '0%');
                    $('#progressText').text('0%');
                    $('#progressMessage').text('–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
                    return;
                }
                
                $.get('/api/progress', function(data) {
                    console.log('–ü—Ä–æ–≥—Ä–µ—Å—Å:', data);
                    if (data.status === 'complete') {
                        clearInterval(interval);
                        $('#progressContainer').hide();
                        $('#runForecast').prop('disabled', false);
                        $('#cancelForecast').hide();
                        loadForecastResults();
                    } else if (data.status === 'cancelled') {
                        clearInterval(interval);
                        $('#progressContainer').hide();
                        $('#runForecast').prop('disabled', false);
                        $('#cancelForecast').hide();
                        $('#progressMessage').text('–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
                    } else if (data.percentage !== undefined) {
                        $('#progressBar').css('width', data.percentage + '%');
                        $('#progressText').text(data.percentage + '%');
                        $('#progressMessage').text(data.message || '');
                    }
                }).fail(function() { // –î–æ–±–∞–≤–∏–ª –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–∫–∏ –¥–ª—è /api/progress
                    clearInterval(interval);
                    $('#progressContainer').hide();
                    $('#runForecast').prop('disabled', false);
                    $('#cancelForecast').hide();
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è.');
                });
            }, 500);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≥–Ω–æ–∑–∞
        function loadForecastResults() {
            console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≥–Ω–æ–∑–∞...');
            $('#dateFilter').show();
            $('#exportExcel').show();
            $('.loading-spinner').show();
            $('#chartContainer').html('<div id="plotlyChart"></div>'); // –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            currentMonth = new Date();
            setDatesForCurrentMonth();
            updateMonthNavigation();

            $.get('/api/get_forecast_data', function(response) {
                console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞:', response);
                $('.loading-spinner').hide();

                if (response.error) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
                     $('#chartContainer').html(`
                        <div class="empty-state">
                            <i class="bi bi-exclamation-triangle"></i>
                            <h5>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞</h5>
                            <p>${response.error}</p>
                        </div>
                    `);
                    return;
                }

                if (response.data && response.data.length > 0) {
                    const config = {
                        responsive: true,
                        displayModeBar: true,
                        modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                        displaylogo: false
                    };

                    Plotly.newPlot('plotlyChart', response.data, response.layout, config);
                    if (response.summary_data) {
                        renderSummaryTable(response.summary_data);
                    } else {
                        renderSummaryTable(null); // Clear table or show default
                    }
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø–æ –º–µ—Å—è—Ü–∞–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                    updateMonthNavigation();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—ã –µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–∏—à–ª–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
                    if (response.current_dates) {
                        if (response.current_dates.date_from) {
                            $('#dateFrom').val(response.current_dates.date_from);
                        }
                        if (response.current_dates.date_to) {
                            $('#dateTo').val(response.current_dates.date_to);
                        }
                        updateMonthIndicatorFromDates();
                    }
                    
                    // –¢–∞–±—ã —É–∂–µ –≤–∏–¥–Ω—ã, –ø–∞–Ω–µ–ª—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Ç–∞–±—ã
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫
                    forecastData = response;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
                    if (response.metrics && Object.keys(response.metrics).length > 0) {
                        try {
                            renderMetricsTable(response.metrics, response.structured_recommendations);
                        } catch (e) {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –º–µ—Ç—Ä–∏–∫:', e);
                        }
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫ –ø–æ—Å–ª–µ –ø—Ä–æ–≥–Ω–æ–∑–∞
                    $('#adjustmentsSection').show();
                    loadAdjustmentsManager();
                } else {
                    $('#chartContainer').html(`
                        <div class="empty-state">
                            <i class="bi bi-exclamation-circle"></i>
                            <h5>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h5>
                            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–∏–µ –∫–∞—Ñ–µ.</p>
                        </div>
                    `);
                    renderSummaryTable(null); // Clear table if no chart data
                }
            }).fail(function(xhr, status, error) {
                $('.loading-spinner').hide();
                renderSummaryTable(null); // Clear table on error
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞:', errorMsg);
                $('#chartContainer').html(`
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle"></i>
                        <h5>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞</h5>
                        <p>${errorMsg}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.</p>
                    </div>
                `);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫
        function loadAdjustmentsManager() {
            const container = $('#adjustmentsContainer');
            container.html(`
                <div class="mb-3">
                    <button class="btn btn-sm btn-primary" id="addAdjustment">
                        <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É
                    </button>
                </div>
                <div id="adjustmentsList"></div>
                <div class="mt-3">
                    <button class="btn btn-success" id="applyAdjustments" style="display: none;">
                        <i class="bi bi-check-circle"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
                    </button>
                </div>
            `);
            
            updateAdjustmentCafeList();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
            $('#addAdjustment').click(function() {
                const adjId = Date.now();
                const adjItem = $(`
                    <div class="card mb-3 adjustment-item" data-adj-id="${adjId}">
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <label class="form-label small">–ö–∞—Ñ–µ</label>
                                    <select class="form-select adj-cafe" id="adjCafe${adjId}">
                                        <option value="ALL">–í—Å–µ –∫–∞—Ñ–µ</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</label>
                                    <select class="form-select adj-metric">
                                        <option value="revenue">–í—ã—Ä—É—á–∫–∞</option>
                                        <option value="traffic">–¢—Ä–∞—Ñ–∏–∫</option>
                                        <option value="avg_check">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <label class="form-label small">–¢–∏–ø –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏</label>
                                    <select class="form-select adj-type">
                                        <option value="percent">–ü—Ä–æ—Ü–µ–Ω—Ç</option>
                                        <option value="absolute">–ê–±—Å–æ–ª—é—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">–ó–Ω–∞—á–µ–Ω–∏–µ</label>
                                    <input type="number" class="form-control adj-value" step="any" placeholder="0">
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <label class="form-label small">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                                    <input type="date" class="form-control adj-date-from">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                                    <input type="date" class="form-control adj-date-to">
                                </div>
                            </div>
                            <div class="text-end">
                                <button class="btn btn-sm btn-danger remove-adj">
                                    <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    </div>
                `);
                
                $('#adjustmentsList').append(adjItem);
                updateAdjustmentCafeList();
                $('#applyAdjustments').show();
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
                adjItem.find('.remove-adj').click(function() {
                    adjItem.remove();
                    if ($('.adjustment-item').length === 0) {
                        $('#applyAdjustments').hide();
                    }
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫
            $('#applyAdjustments').click(function() {
                const adjustments = [];
                $('.adjustment-item').each(function() {
                    const item = $(this);
                    adjustments.push({
                        cafe: item.find('.adj-cafe').val(),
                        metric: item.find('.adj-metric').val(),
                        type: item.find('.adj-type').val(),
                        value: parseFloat(item.find('.adj-value').val()),
                        dateFrom: item.find('.adj-date-from').val(),
                        dateTo: item.find('.adj-date-to').val()
                    });
                });
                
                $.ajax({
                    url: '/api/apply_adjustments',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ adjustments: adjustments }),
                    success: function(response) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞–º–∏
                        Plotly.react('plotlyChart', response.data, response.layout);
                        if (response.summary_data) {
                            renderSummaryTable(response.summary_data);
                        }
                        alert('–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã');
                    },
                    error: function(xhr) {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫: ' + (xhr.responseJSON ? xhr.responseJSON.error : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                });
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
        function updateChart() {
            const dateFrom = $('#dateFrom').val();
            const dateTo = $('#dateTo').val();

            let url = '/api/get_forecast_data?';
            if (dateFrom) url += `date_from=${dateFrom}&`;
            if (dateTo) url += `date_to=${dateTo}&`;
            url += `view_type=${currentViewType}&`;
            if (currentViewType === 'bar') {
                url += `aggregation_period=${currentAggregationPeriod}&`;
            }

            $('.loading-spinner').show();
             // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
            if ($('#plotlyChart').length === 0) {
                $('#chartContainer').html('<div id="plotlyChart"></div>');
            }


            $.get(url, function(response) {
                $('.loading-spinner').hide();
                 if (response.error) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
                     alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞: ' + response.error);
                    return;
                }
                if (response.data && response.data.length > 0) {
                    Plotly.react('plotlyChart', response.data, response.layout);
                    if (response.summary_data) {
                        renderSummaryTable(response.summary_data);
                    } else {
                        renderSummaryTable(null);
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞
                    if (response.metrics && Object.keys(response.metrics).length > 0) {
                        try {
                            renderMetricsTable(response.metrics, response.structured_recommendations);
                        } catch (e) {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–µ—Ç—Ä–∏–∫:', e);
                        }
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—ã –µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–∏—à–ª–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
                    if (response.current_dates) {
                        if (response.current_dates.date_from) {
                            $('#dateFrom').val(response.current_dates.date_from);
                        }
                        if (response.current_dates.date_to) {
                            $('#dateTo').val(response.current_dates.date_to);
                        }
                        updateMonthIndicatorFromDates();
                    }

                } else {
                     $('#chartContainer').html(`
                        <div class="empty-state">
                            <i class="bi bi-exclamation-circle"></i>
                            <h5>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–∞—Ç–∞–º</h5>
                        </div>
                    `);
                    renderSummaryTable(null);
                }
            }).fail(function(xhr, status, error) {
                $('.loading-spinner').hide();
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞: ' + errorMsg);
                renderSummaryTable(null);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
        function renderMetricsTable(metrics, structuredRecommendations) {
            const metricsTable = $("#metricsTable");
            metricsTable.empty();
            
            Object.entries(metrics).forEach(([cafe, cafeMetrics]) => {
                const metricTypes = ['revenue', 'traffic', 'check'];
                const metricNames = {
                    'revenue': '–í—ã—Ä—É—á–∫–∞',
                    'traffic': '–¢—Ä–∞—Ñ–∏–∫',
                    'check': '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫'
                };
                
                metricTypes.forEach((metricType, index) => {
                    let row = $('<tr>');
                    
                    // –ö–∞—Ñ–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏)
                    if (index === 0) {
                        row.append($('<td>').attr('rowspan', 3).css('vertical-align', 'middle').html(`<strong>${cafe}</strong>`));
                    }
                    
                    // –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å
                    row.append($('<td>').text(metricNames[metricType]));
                    
                    // MAPE —Å —Ü–≤–µ—Ç–æ–≤–æ–π —Ä–∞–∑–º–µ—Ç–∫–æ–π
                    let mapeCell = $('<td>');
                    const mapeKey = `MAPE_${metricType}`;
                    if (cafeMetrics[mapeKey] !== null && cafeMetrics[mapeKey] !== undefined) {
                        let mapeValue = cafeMetrics[mapeKey];
                        let mapeClass = getMapeColorClass(mapeValue);
                        mapeCell.html(`<span class="badge ${mapeClass}">${mapeValue.toFixed(2)}%</span>`);
                    } else {
                        mapeCell.text("N/A");
                    }
                    row.append(mapeCell);
                    
                    // MAE
                    const maeKey = `MAE_${metricType}`;
                    const maeValue = cafeMetrics[maeKey];
                    let maeText = "N/A";
                    if (maeValue !== null && maeValue !== undefined) {
                        if (metricType === 'traffic') {
                            maeText = maeValue.toLocaleString('ru-RU');
                        } else {
                            maeText = maeValue.toLocaleString('ru-RU') + " ‚ÇΩ";
                        }
                    }
                    row.append($('<td>').text(maeText));
                    
                    // RMSE
                    const rmseKey = `RMSE_${metricType}`;
                    const rmseValue = cafeMetrics[rmseKey];
                    let rmseText = "N/A";
                    if (rmseValue !== null && rmseValue !== undefined) {
                        if (metricType === 'traffic') {
                            rmseText = rmseValue.toLocaleString('ru-RU');
                        } else {
                            rmseText = rmseValue.toLocaleString('ru-RU') + " ‚ÇΩ";
                        }
                    }
                    row.append($('<td>').text(rmseText));
                    
                    // R¬≤
                    const r2Key = `R2_${metricType}`;
                    const r2Value = cafeMetrics[r2Key];
                    row.append($('<td>').text(r2Value !== null ? r2Value.toFixed(4) : "N/A"));
                    
                    // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏)
                    if (index === 0) {
                        let recCell = $('<td>').attr('rowspan', 3).css('vertical-align', 'middle');
                        
                        if (structuredRecommendations && structuredRecommendations[cafe]) {
                            const structRecs = structuredRecommendations[cafe];
                            
                            // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
                            const btnId = `rec-btn-${cafe.replace(/\s+/g, '-')}`;
                            recCell.html(`
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                        id="${btnId}"
                                        data-bs-toggle="popover"
                                        data-bs-trigger="focus"
                                        title="–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è ${cafe}">
                                    <i class="bi bi-lightbulb"></i> –ü–æ–∫–∞–∑–∞—Ç—å
                                </button>
                            `);
                            
                            // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø–æ–ø–æ–≤–µ—Ä–∞
                            let popoverContent = '<div class="recommendation-content">';
                            
                            metricTypes.forEach(mType => {
                                if (structRecs[mType]) {
                                    const rec = structRecs[mType];
                                    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π —Å –¥–µ—Ñ–æ–ª—Ç–∞–º–∏
                                    const colorClass = rec.color_class || 'metric-warning';
                                    const qualityRus = rec.quality_rus || '–ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';
                                    const generalRec = rec.general_recommendation || '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö';
                                    const actionReq = rec.action_required || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏';
                                    const allTips = rec.all_tips || ['–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö'];
                                    
                                    popoverContent += `
                                        <div class="mb-3">
                                            <h6>${metricNames[mType]} 
                                                <span class="badge ${colorClass}">${qualityRus}</span>
                                            </h6>
                                            <p class="mb-1"><strong>${generalRec}</strong></p>
                                            <p class="mb-1 text-danger">${actionReq}</p>
                                            <ul class="recommendation-list small">
                                                ${allTips.slice(0, 3).map(tip => `<li>${tip}</li>`).join('')}
                                            </ul>
                                        </div>
                                    `;
                                }
                            });
                            
                            popoverContent += '</div>';
                            
                            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ø–æ–≤–µ—Ä–∞ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ DOM
                            setTimeout(() => {
                                const popover = new bootstrap.Popover(document.getElementById(btnId), {
                                    html: true,
                                    content: popoverContent,
                                    placement: 'left',
                                    customClass: 'recommendation-popover',
                                    sanitize: false
                                });
                            }, 100);
                        }
                        
                        row.append(recCell);
                    }
                    
                    metricsTable.append(row);
                });
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —Å–æ —Å–≤–æ–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        function renderSummaryTable(summaryData) {
            const formatNumber = (num, options = {}) => {
                if (isNaN(num) || num === null || num === undefined) return '---';
                return num.toLocaleString('ru-RU', options);
            };
            
            const calculateDeviation = (actual, forecast) => {
                if (forecast === 0) return 0;
                return ((actual / forecast) - 1) * 100;
            };

            const defaultCell = '---';
            const tbody = $('#cafeSummaryBody');
            tbody.empty();

            if (!summaryData || !summaryData.cafes) {
                // Clear totals
                $('#totalRevenueForecast').text(defaultCell);
                $('#totalTrafficForecast').text(defaultCell);
                $('#totalAvgCheckForecast').text(defaultCell);
                $('#totalRevenueActual').text(defaultCell);
                $('#totalTrafficActual').text(defaultCell);
                $('#totalAvgCheckActual').text(defaultCell);
                $('#totalRevenueTotal').text(defaultCell);
                $('#totalTrafficTotal').text(defaultCell);
                $('#totalAvgCheckTotal').text(defaultCell);
                $('#totalRevenueDeviation').text(defaultCell);
                $('#totalTrafficDeviation').text(defaultCell);
                $('#totalAvgCheckDeviation').text(defaultCell);
                return;
            }

            // Populate cafe rows
            Object.entries(summaryData.cafes).forEach(([cafe, data]) => {
                const revActual = data.revenue.actual || 0;
                const revForecast = data.revenue.forecast || 0;
                const revDelta = revActual - revForecast;  // –î–µ–ª—å—Ç–∞ = –§–∞–∫—Ç - –ü–ª–∞–Ω
                const trafActual = data.traffic.actual || 0;
                const trafForecast = data.traffic.forecast || 0;
                const trafDelta = trafActual - trafForecast;  // –î–µ–ª—å—Ç–∞ = –§–∞–∫—Ç - –ü–ª–∞–Ω
                
                const avgCheckActual = trafActual !== 0 ? revActual / trafActual : 0;
                const avgCheckForecast = trafForecast !== 0 ? revForecast / trafForecast : 0;
                const avgCheckDelta = avgCheckActual - avgCheckForecast;  // –î–µ–ª—å—Ç–∞ = –§–∞–∫—Ç - –ü–ª–∞–Ω
                
                const revDeviation = calculateDeviation(revActual, revForecast);
                const trafDeviation = calculateDeviation(trafActual, trafForecast);
                const checkDeviation = calculateDeviation(avgCheckActual, avgCheckForecast);
                
                const row = $('<tr>');
                row.append($('<td>').text(cafe));
                // –ü–ª–∞–Ω
                row.append($('<td>').addClass('plan-group').text(formatNumber(revForecast, { minimumFractionDigits: 0, maximumFractionDigits: 0 })));
                row.append($('<td>').addClass('plan-group').text(formatNumber(trafForecast, { maximumFractionDigits: 0 })));
                row.append($('<td>').addClass('plan-group').text(formatNumber(avgCheckForecast, { minimumFractionDigits: 0, maximumFractionDigits: 0 })));
                // –§–∞–∫—Ç
                row.append($('<td>').addClass('fact-group').text(formatNumber(revActual, { minimumFractionDigits: 0, maximumFractionDigits: 0 })));
                row.append($('<td>').addClass('fact-group').text(formatNumber(trafActual, { maximumFractionDigits: 0 })));
                row.append($('<td>').addClass('fact-group').text(formatNumber(avgCheckActual, { minimumFractionDigits: 0, maximumFractionDigits: 0 })));
                // –î–µ–ª—å—Ç–∞
                row.append($('<td>').addClass('total-group').text(formatNumber(revDelta, { minimumFractionDigits: 0, maximumFractionDigits: 0 })));
                row.append($('<td>').addClass('total-group').text(formatNumber(trafDelta, { maximumFractionDigits: 0 })));
                row.append($('<td>').addClass('total-group').text(formatNumber(avgCheckDelta, { minimumFractionDigits: 0, maximumFractionDigits: 0 })));
                // –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —Å —Ü–≤–µ—Ç–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π
                const getDeviationClass = (value) => {
                    if (value > 5) return 'deviation-positive';
                    if (value < -5) return 'deviation-negative';
                    return 'deviation-neutral';
                };
                
                row.append($('<td>').addClass('deviation-group').addClass(getDeviationClass(revDeviation))
                    .text(revDeviation !== 0 ? formatNumber(revDeviation, { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%' : '0%'));
                row.append($('<td>').addClass('deviation-group').addClass(getDeviationClass(trafDeviation))
                    .text(trafDeviation !== 0 ? formatNumber(trafDeviation, { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%' : '0%'));
                row.append($('<td>').addClass('deviation-group').addClass(getDeviationClass(checkDeviation))
                    .text(checkDeviation !== 0 ? formatNumber(checkDeviation, { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%' : '0%'));
                tbody.append(row);
            });

            // Update totals
            if (summaryData.total) {
                const totalData = summaryData.total;
                const revActual = totalData.revenue.actual || 0;
                const revForecast = totalData.revenue.forecast || 0;
                const revDelta = revActual - revForecast;  // –î–µ–ª—å—Ç–∞ = –§–∞–∫—Ç - –ü–ª–∞–Ω
                const trafActual = totalData.traffic.actual || 0;
                const trafForecast = totalData.traffic.forecast || 0;
                const trafDelta = trafActual - trafForecast;  // –î–µ–ª—å—Ç–∞ = –§–∞–∫—Ç - –ü–ª–∞–Ω
                
                const avgCheckActual = trafActual !== 0 ? revActual / trafActual : 0;
                const avgCheckForecast = trafForecast !== 0 ? revForecast / trafForecast : 0;
                const avgCheckDelta = avgCheckActual - avgCheckForecast;  // –î–µ–ª—å—Ç–∞ = –§–∞–∫—Ç - –ü–ª–∞–Ω
                
                const revDeviation = calculateDeviation(revActual, revForecast);
                const trafDeviation = calculateDeviation(trafActual, trafForecast);
                const checkDeviation = calculateDeviation(avgCheckActual, avgCheckForecast);
                
                $('#totalRevenueForecast').text(formatNumber(revForecast, { minimumFractionDigits: 0, maximumFractionDigits: 0 }));
                $('#totalTrafficForecast').text(formatNumber(trafForecast, { maximumFractionDigits: 0 }));
                $('#totalAvgCheckForecast').text(formatNumber(avgCheckForecast, { minimumFractionDigits: 0, maximumFractionDigits: 0 }));
                $('#totalRevenueActual').text(formatNumber(revActual, { minimumFractionDigits: 0, maximumFractionDigits: 0 }));
                $('#totalTrafficActual').text(formatNumber(trafActual, { maximumFractionDigits: 0 }));
                $('#totalAvgCheckActual').text(formatNumber(avgCheckActual, { minimumFractionDigits: 0, maximumFractionDigits: 0 }));
                $('#totalRevenueTotal').text(formatNumber(revDelta, { minimumFractionDigits: 0, maximumFractionDigits: 0 }));
                $('#totalTrafficTotal').text(formatNumber(trafDelta, { maximumFractionDigits: 0 }));
                $('#totalAvgCheckTotal').text(formatNumber(avgCheckDelta, { minimumFractionDigits: 0, maximumFractionDigits: 0 }));
                const getDeviationClass = (value) => {
                    if (value > 5) return 'deviation-positive';
                    if (value < -5) return 'deviation-negative';
                    return 'deviation-neutral';
                };
                
                $('#totalRevenueDeviation').text(revDeviation !== 0 ? formatNumber(revDeviation, { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%' : '0%')
                    .removeClass('deviation-positive deviation-negative deviation-neutral').addClass(getDeviationClass(revDeviation));
                $('#totalTrafficDeviation').text(trafDeviation !== 0 ? formatNumber(trafDeviation, { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%' : '0%')
                    .removeClass('deviation-positive deviation-negative deviation-neutral').addClass(getDeviationClass(trafDeviation));
                $('#totalAvgCheckDeviation').text(checkDeviation !== 0 ? formatNumber(checkDeviation, { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%' : '0%')
                    .removeClass('deviation-positive deviation-negative deviation-neutral').addClass(getDeviationClass(checkDeviation));
            }
        }
    </script>
</body>
</html>